<!doctype html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0e1520">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Schedule • Cyber Solutions LLC Schedule Manager</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <header class="header">
    <div class="title">
      <div>
        <h1 class="h1">Cyber Solutions LLC Schedule Manager</h1>
        <div class="sub">My schedule (read-only)</div>
      </div>
    </div>
  </header>

  <div class="container">
    <section class="card">
      <h2>My schedule</h2>
      <div id="status" class="small">Loading…</div>
      <div id="content" class="list"></div>
      <div class="btnRow" style="margin-top:12px;">
        <a class="btn secondary" id="printLink" href="print.html">Print / Save PDF</a>
        <button class="btn secondary" id="logoutBtn" type="button">Sign out</button>
      </div>
    </section>

    <section class="card">
      <h2>Forgot / Change Login</h2>
      <div class="small" id="loginMeta">Loading…</div>
      <div class="hr"></div>
      <form id="loginRequestForm" autocomplete="off">
        <label for="reqUsername">Requested new username (optional)</label>
        <input id="reqUsername" placeholder="Leave blank to keep current username" autocomplete="username" autocapitalize="none" />

        <label for="reqPin">Requested new 4-digit PIN (optional)</label>
        <input id="reqPin" type="password" inputmode="numeric" pattern="[0-9]{4}" maxlength="4" placeholder="4 digits" autocomplete="new-password" />

        <label for="reqNote">Note (optional)</label>
        <input id="reqNote" placeholder="Optional reason for your manager" />

        <div class="btnRow" style="margin-top:12px;">
          <button class="btn" type="submit">Submit request</button>
          <button class="btn secondary" id="reqClearBtn" type="button">Clear</button>
        </div>
      </form>
      <div class="small" style="margin-top:10px;">
        Your manager reviews requests for your company code. Your login does not change until approved.
      </div>
    </section>
  </div>

  <script src="assets/store.js"></script>
  <script src="assets/app.js"></script>
  <script>
    (async () => {
      await JanitorApp.init({ pageTitle: "My Schedule • Cyber Solutions LLC Schedule Manager", wireSaveBar: false });

      const statusEl = document.getElementById("status");
      const contentEl = document.getElementById("content");
      const printLink = document.getElementById("printLink");
      const loginMetaEl = document.getElementById("loginMeta");
      const reqUsernameEl = document.getElementById("reqUsername");
      const reqPinEl = document.getElementById("reqPin");
      const reqNoteEl = document.getElementById("reqNote");
      const session = JanitorAuth.getSession();
      const normalizeCompany = (s) => String(s || "").trim().toUpperCase();
      const normalizeUsername = (s) => String(s || "").trim().toLowerCase();
      const pinOk = (p) => /^[0-9]{4}$/.test(String(p || "").trim());

      document.getElementById("logoutBtn").addEventListener("click", () => JanitorAuth.signOut());

      loginMetaEl.textContent =
        `Company code: ${normalizeCompany(session?.companyCode)} • Username: ${normalizeUsername(session?.username)}`;

      document.getElementById("reqClearBtn").addEventListener("click", () => {
        reqUsernameEl.value = "";
        reqPinEl.value = "";
        reqNoteEl.value = "";
        reqUsernameEl.focus();
      });

      document.getElementById("loginRequestForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const nextUsername = normalizeUsername(reqUsernameEl.value);
        const nextPin = String(reqPinEl.value || "").trim();
        const note = String(reqNoteEl.value || "").trim();

        const wantsPin = pinOk(nextPin);
        const wantsUsername = !!nextUsername && nextUsername !== normalizeUsername(session?.username);
        if (!wantsPin && !wantsUsername) return JanitorApp.toast("Enter a new username and/or a new PIN.", { type: "warn" });
        if (wantsUsername && !wantsPin) return JanitorApp.toast("Changing the username requires setting a new PIN.", { type: "warn" });
        if (!wantsPin && nextPin) return JanitorApp.toast("PIN must be exactly 4 digits.", { type: "warn" });

        try {
          await JanitorStore.resetDraftToSaved();
          JanitorStore.createRequest({
            type: "employee_change_credentials",
            proposedUsername: wantsUsername ? nextUsername : "",
            proposedPin: wantsPin ? nextPin : "",
            note,
          });
          await JanitorStore.save();
          JanitorApp.toast("Request submitted.", { type: "success" });
          reqUsernameEl.value = "";
          reqPinEl.value = "";
          reqNoteEl.value = "";
        } catch (err) {
          try { await JanitorStore.resetDraftToSaved(); } catch {}
          JanitorApp.toast(err?.message || "Request failed.", { type: "error" });
        }
      });

      // Placeholder until employee accounts are linked to an employeeId (Supabase or manager UI).
      const employeeId = session?.employeeId;
      if (!employeeId) {
        statusEl.innerHTML =
          "Your login is not linked to an employee record yet.<br/>" +
          "Ask your manager to link your account in <strong>Users / Access</strong>.";
        contentEl.innerHTML = "";
        printLink.style.display = "none";
      } else {
        printLink.href = `print.html?empId=${encodeURIComponent(employeeId)}`;

        const s = JanitorStore.getSaved();
        const emp = s.employees.find(e => e.id === employeeId);
        const crewIds = new Set((s.crewMembers || []).filter(cm => cm.empId === employeeId).map(cm => cm.crewId));
        const shifts = (s.shifts || []).filter(sh => {
          const targetType = sh.targetType || (sh.empId ? "employee" : "");
          const targetId = sh.targetId || sh.empId || "";
          if (targetType === "employee") return targetId === employeeId;
          if (targetType === "crew") return crewIds.has(targetId);
          return false;
        }).sort((a,b) => (a.date + a.start).localeCompare(b.date + b.start));

        statusEl.textContent = emp ? `Employee: ${emp.name}` : "Employee not found.";

        const locById = Object.fromEntries((s.locations || []).map(l => [l.id, l]));
        const jobById = Object.fromEntries((s.jobTypes || []).map(j => [j.id, j]));
        const crewById = Object.fromEntries((s.crews || []).map(c => [c.id, c]));

        contentEl.innerHTML = "";
        if (!shifts.length) {
          contentEl.innerHTML = `<div class="small">No shifts scheduled.</div>`;
          return;
        }

        contentEl.insertAdjacentHTML("beforeend", `<div class="small">${shifts.length} shift(s) found.</div>`);

        const byDate = new Map();
        for (const sh of shifts) {
          const key = String(sh.date || "");
          if (!byDate.has(key)) byDate.set(key, []);
          byDate.get(key).push(sh);
        }

        const dates = Array.from(byDate.keys()).sort((a,b) => String(a).localeCompare(String(b)));
        for (const date of dates) {
          const group = byDate.get(date) || [];
          const wrap = document.createElement("div");
          wrap.className = "item";
          wrap.innerHTML = `<div class="meta"><strong>${JanitorApp.escapeHtml(date)}</strong></div>`;

          const meta = wrap.querySelector(".meta");
          for (const sh of group) {
            const targetType = sh.targetType || (sh.empId ? "employee" : "");
            const targetId = sh.targetId || sh.empId || "";
            const isCrew = targetType === "crew";
            const crewName = isCrew ? (crewById[targetId]?.name || "Crew") : "";
            const loc = locById[sh.locId];
            const jobs = (sh.jobTypeIds || []).map(id => jobById[id]?.name).filter(Boolean);

            const block = document.createElement("div");
            block.style.marginTop = "10px";
            block.style.paddingTop = "10px";
            block.style.borderTop = "1px solid rgba(255,255,255,0.10)";
            block.innerHTML = `
              <div><strong>${JanitorApp.escapeHtml(sh.start)} - ${JanitorApp.escapeHtml(sh.end)}</strong></div>
              <div class="muted">${JanitorApp.escapeHtml(loc?.name || "—")}${loc?.address ? ` • ${JanitorApp.escapeHtml(loc.address.replace(/\\n/g, " • "))}` : ""}</div>
              ${isCrew ? `<span class="pill">Crew shift: ${JanitorApp.escapeHtml(crewName)}</span>` : ""}
              ${jobs.length ? `<div class="small" style="margin-top:6px;">Jobs: ${JanitorApp.escapeHtml(jobs.join(", "))}</div>` : ""}
              ${sh.notes ? `<div class="small" style="margin-top:6px;">Notes: ${JanitorApp.escapeHtml(sh.notes)}</div>` : ""}
            `;
            meta.appendChild(block);
          }

          contentEl.appendChild(wrap);
        }
      }
    })();
  </script>
</body>
</html>
