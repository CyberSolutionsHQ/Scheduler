{"migrations":[{"name":"0001_schema.sql","timestamp":null},{"name":"0002_rls_policies.sql","timestamp":null},{"name":"20251218060620_backend_foundation_company_code.sql","timestamp":"20251218060620"},{"name":"20251218060919_backend_foundation_rls_policies.sql","timestamp":"20251218060919"},{"name":"20251218061853_backend_foundation_tenant_columns.sql","timestamp":"20251218061853"},{"name":"20251219043316_cleanup_platform_admin_platform.sql","timestamp":"20251219043316"},{"name":"20251219090000_platform_admin_break_glass_recovery.sql","timestamp":"20251219090000"},{"name":"20251221015020_phase2_build.sql","timestamp":"20251221015020"}],"functions":[{"name":"_shared","is_shared":true,"files":["supabase/functions/_shared/admin.ts","supabase/functions/_shared/cors.ts"],"index_file":null,"index_sha256":null,"synopsis":{"imports":[],"exported_handler":null,"required_env_vars":[]},"snippets":{"head":[],"tail":[]}},{"name":"approve_request","is_shared":false,"files":["supabase/functions/approve_request/index.ts"],"index_file":"supabase/functions/approve_request/index.ts","index_sha256":"79dadc71e94f1f050fce8af598c652490a6fa2c709dd20af797986702a07a96d","synopsis":{"imports":["../_shared/cors.ts"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertCallerActive,","  assertPin,","  computePinHash,","  createAdminClient,","  getCallerContext,","  internalEmail,","  json,","  normalizeUsername,","} from \"../_shared/admin.ts\";","","function assertUuid(value: string, field: string): void {","  const v = (value ?? \"\").trim();","  const uuidRe =","    /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;","  if (!uuidRe.test(v)) throw new Error(`${field} must be a UUID`);","}","","function appendDecisionNote(existing: string | null, decisionNote: string): string {","  const trimmed = (decisionNote ?? \"\").trim();","  const line = `Decision: ${trimmed}`;","  return existing && existing.trim().length > 0 ? `${existing}\\n${line}` : line;","}","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const supabaseAdmin = createAdminClient();","    const caller = await getCallerContext(supabaseAdmin, req);","    assertCallerActive(caller);","","    const body = await req.json();","    const requestId = String(body.requestId ?? \"\").trim();","    assertUuid(requestId, \"requestId\");","    const decisionNote = String(body.decisionNote ?? \"\").trim();","","    const { data: requestRow, error: requestError } = await supabaseAdmin","      .from(\"requests\")","      .select(","        'id, \"companyCode\", type, status, \"requesterUserId\", \"targetUserId\", \"proposedUsername\", \"proposedPin\", \"decisionNote\"',","      )","      .eq(\"id\", requestId)","      .single();","    if (requestError) throw new Error(requestError.message);","    if (requestRow.status !== \"pending\") throw new Error(\"Request is not pending\");","","    const requestType: string = requestRow.type;"],"tail":["        newUsername,","        newPin,","      );","    }","","    const { error: userUpdateError } = await supabaseAdmin","      .from(\"users\")","      .update(userUpdate)","      .eq(\"id\", targetUser.id);","    if (userUpdateError) throw new Error(userUpdateError.message);","","    const { error: requestUpdateError } = await supabaseAdmin","      .from(\"requests\")","      .update({","        status: \"approved\",","        handledAt: new Date().toISOString(),","        handledBy: caller.authUserId,","        decisionNote: appendDecisionNote(requestRow.decisionNote, decisionNote),","      })","      .eq(\"id\", requestRow.id);","    if (requestUpdateError) throw new Error(requestUpdateError.message);","","    return json({ ok: true }, { headers: corsHeaders });","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});"]}},{"name":"auth_login","is_shared":false,"files":["supabase/functions/auth_login/index.ts"],"index_file":"supabase/functions/auth_login/index.ts","index_sha256":"1a53be81c7a846a7771abaf7f197a7213b671c247a8998b51c49bde26dab7f0b","synopsis":{"imports":["../_shared/cors.ts","https://esm.sh/@supabase/supabase-js@2.49.1"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { createClient } from \"https://esm.sh/@supabase/supabase-js@2.49.1\";","import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertPin,","  createAdminClient,","  getEnv,","  internalEmail,","  json,","  normalizeCompanyCode,","  normalizeUsername,","} from \"../_shared/admin.ts\";","","type LoginBody = {","  companyCode?: string;","  username?: string;","  email?: string;","  pin?: string;","};","","function normalizeEmail(value: string): string {","  const email = String(value ?? \"\").trim();","  if (!email || !email.includes(\"@\")) throw new Error(\"email is required\");","  return email.toLowerCase();","}","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const body = (await req.json()) as LoginBody;","    const pin = String(body.pin ?? \"\").trim();","    assertPin(pin, \"pin\");","","    let email = \"\";","    if (body.email) {","      email = normalizeEmail(body.email);","    } else {","      const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));","      const username = normalizeUsername(String(body.username ?? \"\"));","      email = internalEmail(companyCode, username).toLowerCase();","    }","","    const url = getEnv(\"SUPABASE_URL\");","[REDACTED LINE]","[REDACTED LINE]","      auth: { persistSession: false, autoRefreshToken: false },","      global: { headers: { \"X-Client-Info\": \"schedule-manager-edge\" } },","    });",""],"tail":["    }","","    return json(","      {","        session: {","          access_token: data.session.access_token,","          refresh_token: data.session.refresh_token,","          expires_in: data.session.expires_in,","          token_type: data.session.token_type,","          user_id: data.user.id,","        },","        profile: {","          id: userRow.id,","          companyCode: userRow.companyCode,","          username: userRow.username,","          role: userRow.role,","          employeeId: userRow.employeeId,","          active: userRow.active,","          forcePinChange: Boolean(userRow.force_pin_change),","        },","      },","      { headers: corsHeaders },","    );","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});"]}},{"name":"bootstrap_platform_admin","is_shared":false,"files":["supabase/functions/bootstrap_platform_admin/index.ts"],"index_file":"supabase/functions/bootstrap_platform_admin/index.ts","index_sha256":"67127f3cab655cecba5dd87a35fd7c710d44926c573582b087453c9bdaf355ca","synopsis":{"imports":["../_shared/cors.ts"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertPin,","  computePinHash,","  createAdminClient,","  internalEmail,","  json,","  normalizeUsername,","} from \"../_shared/admin.ts\";","","function getEnv(name: string): string {","  const value = Deno.env.get(name);","  if (!value) throw new Error(`Missing env var: ${name}`);","  return value;","}","","type BootstrapBody = {","  token?: string;","  username?: string;","  pin?: string;","};","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const supabaseAdmin = createAdminClient();","","    const body = (await req.json()) as BootstrapBody;","    const token = String(body.token ?? \"\").trim();","    const expected = getEnv(\"BOOTSTRAP_TOKEN\");","    if (!token || token !== expected) {","      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });","    }","","    const { data: existingAdmins, error: existingError } = await supabaseAdmin","      .from(\"users\")","      .select(\"id\")","      .eq(\"role\", \"platform_admin\")","      .limit(1);","    if (existingError) throw new Error(existingError.message);","    if ((existingAdmins ?? []).length > 0) {","      return json(","        { error: \"platform_admin already exists\" },","        { status: 409, headers: corsHeaders },","      );","    }","","    const companyCode = \"PLATFORM\";"],"tail":["      username,","      pinHash,","      role: \"platform_admin\",","      employeeId: null,","      active: true,","    });","","    if (insertError) {","      await supabaseAdmin.auth.admin.deleteUser(authUserId);","      throw new Error(insertError.message);","    }","","    return json(","      {","        ok: true,","        companyCode,","        username,","        pin,","        authUserId,","      },","      { headers: corsHeaders },","    );","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});",""]}},{"name":"create_company_with_manager","is_shared":false,"files":["supabase/functions/create_company_with_manager/index.ts"],"index_file":"supabase/functions/create_company_with_manager/index.ts","index_sha256":"a51fb41748076cb841e49c341ee13dff945766d31d7e9e3b2eac459208d5435e","synopsis":{"imports":["../_shared/cors.ts"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertCallerActive,","  assertPin,","  computePinHash,","  createAdminClient,","  getCallerContext,","  internalEmail,","  json,","  normalizeCompanyCode,","  normalizeUsername,","} from \"../_shared/admin.ts\";","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const supabaseAdmin = createAdminClient();","    const caller = await getCallerContext(supabaseAdmin, req);","    assertCallerActive(caller);","    if (caller.role !== \"platform_admin\") {","      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });","    }","","    const body = await req.json();","    const companyName = String(body.companyName ?? \"\").trim();","    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));","    const managerUsername = normalizeUsername(String(body.managerUsername ?? \"\"));","    const managerPin = String(body.managerPin ?? \"\").trim();","    assertPin(managerPin, \"managerPin\");","    if (!companyName) throw new Error(\"companyName is required\");","","    const { data: insertedCompany, error: companyError } = await supabaseAdmin","      .from(\"companies\")","      .insert({","        companyCode,","        companyName,","        isDisabled: false,","        supportEnabled: false,","      })","      .select('id, \"companyCode\"')","      .single();","","    if (companyError) throw new Error(companyError.message);","","    const email = internalEmail(companyCode, managerUsername);","    const { data: authCreate, error: authError } = await supabaseAdmin.auth","      .admin.createUser({","        email,"],"tail":["      username: managerUsername,","      pinHash,","      role: \"manager\",","      employeeId: null,","      active: true,","    });","","    if (userRowError) {","      await supabaseAdmin.auth.admin.deleteUser(managerUserId);","      await supabaseAdmin.from(\"companies\").delete().eq(\"id\", insertedCompany.id);","      throw new Error(userRowError.message);","    }","","    return json(","      {","        companyCode,","        managerUsername,","        managerPin,","        companyId: insertedCompany.id,","      },","      { headers: corsHeaders },","    );","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});",""]}},{"name":"create_employee_login","is_shared":false,"files":["supabase/functions/create_employee_login/index.ts"],"index_file":"supabase/functions/create_employee_login/index.ts","index_sha256":"1cf1527e82c1bdc4c3684cfd61339ea0c5b81dd33d94f1526b89288392c3641b","synopsis":{"imports":["../_shared/cors.ts"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertCallerActive,","  assertPin,","  computePinHash,","  createAdminClient,","  getCallerContext,","  internalEmail,","  json,","  normalizeCompanyCode,","  normalizeUsername,","} from \"../_shared/admin.ts\";","","function assertUuid(value: string, field: string): void {","  const v = (value ?? \"\").trim();","  const uuidRe =","    /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;","  if (!uuidRe.test(v)) throw new Error(`${field} must be a UUID`);","}","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const supabaseAdmin = createAdminClient();","    const caller = await getCallerContext(supabaseAdmin, req);","    assertCallerActive(caller);","    if (caller.role !== \"manager\") {","      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });","    }","","    const body = await req.json();","    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));","    if (companyCode !== caller.companyCode) {","      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });","    }","","    const { data: companyRow, error: companyError } = await supabaseAdmin","      .from(\"companies\")","      .select('\"isDisabled\"')","      .eq(\"companyCode\", companyCode)","      .maybeSingle();","    if (companyError) throw new Error(companyError.message);","    if (!companyRow) throw new Error(\"Company not found\");","    if (companyRow.isDisabled) throw new Error(\"Company is disabled\");","","    const employeeId = String(body.employeeId ?? \"\").trim();","    assertUuid(employeeId, \"employeeId\");",""],"tail":["      .admin.getUserById(existingUserId);","    if (authGetError || !authUser.user) {","      throw new Error(authGetError?.message ?? \"Auth user not found\");","    }","","    const updatePayload: { email?: string; password?: string; email_confirm?: boolean } =","      { password: pin };","    if ((authUser.user.email ?? \"\").toLowerCase() !== email.toLowerCase()) {","      updatePayload.email = email;","      updatePayload.email_confirm = true;","    }","","    const { error: authUpdateError } = await supabaseAdmin.auth.admin","      .updateUserById(existingUserId, updatePayload);","    if (authUpdateError) throw new Error(authUpdateError.message);","","    const { error: updateError } = await supabaseAdmin","      .from(\"users\")","      .update({ username, pinHash, active: true })","      .eq(\"id\", existingUserId);","    if (updateError) throw new Error(updateError.message);","","    return json({ username, pin }, { headers: corsHeaders });","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});"]}},{"name":"create_manager_account","is_shared":false,"files":["supabase/functions/create_manager_account/index.ts"],"index_file":"supabase/functions/create_manager_account/index.ts","index_sha256":"1502e3070bff7a07e8940ffd8dbd2c68e5a83a16e1202a227f416878b7b2eacb","synopsis":{"imports":["../_shared/cors.ts"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertCallerActive,","  assertPin,","  computePinHash,","  createAdminClient,","  getCallerContext,","  internalEmail,","  json,","  normalizeCompanyCode,","  normalizeUsername,","} from \"../_shared/admin.ts\";","","type CreateBody = {","  companyCode?: string;","  managerUsername?: string;","  managerPin?: string;","};","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const supabaseAdmin = createAdminClient();","    const caller = await getCallerContext(supabaseAdmin, req);","    assertCallerActive(caller);","    if (caller.role !== \"platform_admin\") {","      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });","    }","","    const body = (await req.json()) as CreateBody;","    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));","    const managerUsername = normalizeUsername(String(body.managerUsername ?? \"\"));","    const managerPin = String(body.managerPin ?? \"\").trim();","    assertPin(managerPin, \"managerPin\");","","    const { data: company, error: companyError } = await supabaseAdmin","      .from(\"companies\")","      .select('\"companyCode\", \"isDisabled\"')","      .eq(\"companyCode\", companyCode)","      .maybeSingle();","    if (companyError) throw new Error(companyError.message);","    if (!company) throw new Error(\"Company not found\");","    if (company.isDisabled) throw new Error(\"Company is disabled\");","","    const { data: existing, error: existingError } = await supabaseAdmin","      .from(\"users\")","      .select(\"id\")","      .eq(\"companyCode\", companyCode)"],"tail":["      companyCode,","      username: managerUsername,","      pinHash,","      role: \"manager\",","      employeeId: null,","      active: true,","    });","","    if (insertError) {","      await supabaseAdmin.auth.admin.deleteUser(managerUserId);","      throw new Error(insertError.message);","    }","","    return json(","      {","        ok: true,","        companyCode,","        managerUsername,","        managerPin,","        managerUserId,","      },","      { headers: corsHeaders },","    );","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});"]}},{"name":"deny_request","is_shared":false,"files":["supabase/functions/deny_request/index.ts"],"index_file":"supabase/functions/deny_request/index.ts","index_sha256":"1779057f779e7ad2af0490f4230896c6f44cc78900ba22ccfc95e18320e2097b","synopsis":{"imports":["../_shared/cors.ts"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertCallerActive,","  createAdminClient,","  getCallerContext,","  json,","} from \"../_shared/admin.ts\";","","function assertUuid(value: string, field: string): void {","  const v = (value ?? \"\").trim();","  const uuidRe =","    /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;","  if (!uuidRe.test(v)) throw new Error(`${field} must be a UUID`);","}","","function appendDecisionNote(existing: string | null, decisionNote: string): string {","  const trimmed = (decisionNote ?? \"\").trim();","  const line = `Decision: ${trimmed}`;","  return existing && existing.trim().length > 0 ? `${existing}\\n${line}` : line;","}","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const supabaseAdmin = createAdminClient();","    const caller = await getCallerContext(supabaseAdmin, req);","    assertCallerActive(caller);","","    const body = await req.json();","    const requestId = String(body.requestId ?? \"\").trim();","    assertUuid(requestId, \"requestId\");","    const decisionNote = String(body.decisionNote ?? \"\").trim();","","    const { data: requestRow, error: requestError } = await supabaseAdmin","      .from(\"requests\")","      .select('id, \"companyCode\", type, status, \"decisionNote\"')","      .eq(\"id\", requestId)","      .single();","    if (requestError) throw new Error(requestError.message);","    if (requestRow.status !== \"pending\") throw new Error(\"Request is not pending\");","","    const requestType: string = requestRow.type;","[REDACTED LINE]","      if (caller.role !== \"manager\") throw new Error(\"forbidden\");","      if (requestRow.companyCode !== caller.companyCode) throw new Error(\"forbidden\");","[REDACTED LINE]","      if (caller.role !== \"platform_admin\") throw new Error(\"forbidden\");","[REDACTED LINE]"],"tail":["      if (caller.role !== \"manager\") throw new Error(\"forbidden\");","      if (requestRow.companyCode !== caller.companyCode) throw new Error(\"forbidden\");","[REDACTED LINE]","      if (caller.role !== \"platform_admin\") throw new Error(\"forbidden\");","[REDACTED LINE]","      if (caller.role !== \"platform_admin\") throw new Error(\"forbidden\");","    } else {","      throw new Error(\"Unknown request type\");","    }","","    const { error: requestUpdateError } = await supabaseAdmin","      .from(\"requests\")","      .update({","        status: \"denied\",","        handledAt: new Date().toISOString(),","        handledBy: caller.authUserId,","        decisionNote: appendDecisionNote(requestRow.decisionNote, decisionNote),","      })","      .eq(\"id\", requestRow.id);","    if (requestUpdateError) throw new Error(requestUpdateError.message);","","    return json({ ok: true }, { headers: corsHeaders });","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});",""]}},{"name":"reset_user_pin","is_shared":false,"files":["supabase/functions/reset_user_pin/index.ts"],"index_file":"supabase/functions/reset_user_pin/index.ts","index_sha256":"acb648755f1bddffd18b0949873d8de24485436e1da7913a163b7dcaad8065c0","synopsis":{"imports":["../_shared/cors.ts"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertCallerActive,","  assertPin,","  computePinHash,","  createAdminClient,","  getCallerContext,","  json,","  normalizeCompanyCode,","  normalizeUsername,","} from \"../_shared/admin.ts\";","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const supabaseAdmin = createAdminClient();","    const caller = await getCallerContext(supabaseAdmin, req);","    assertCallerActive(caller);","","    const body = await req.json();","    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));","    const username = normalizeUsername(String(body.username ?? \"\"));","    const newPin = String(body.newPin ?? \"\").trim();","    assertPin(newPin, \"newPin\");","","    const { data: target, error: targetError } = await supabaseAdmin","      .from(\"users\")","      .select('id, role, \"companyCode\", username')","      .eq(\"companyCode\", companyCode)","      .eq(\"username\", username)","      .maybeSingle();","    if (targetError) throw new Error(targetError.message);","    if (!target) throw new Error(\"User not found\");","","    if (caller.role === \"platform_admin\") {","      if (target.role !== \"manager\") throw new Error(\"forbidden\");","    } else if (caller.role === \"manager\") {","      if (companyCode !== caller.companyCode) throw new Error(\"forbidden\");","      if (target.role !== \"employee\") throw new Error(\"forbidden\");","","      const { data: companyRow, error: companyError } = await supabaseAdmin","        .from(\"companies\")","        .select('\"isDisabled\"')","        .eq(\"companyCode\", companyCode)","        .maybeSingle();","      if (companyError) throw new Error(companyError.message);","      if (!companyRow || companyRow.isDisabled) {","        throw new Error(\"Company is disabled\");"],"tail":["        .eq(\"companyCode\", companyCode)","        .maybeSingle();","      if (companyError) throw new Error(companyError.message);","      if (!companyRow || companyRow.isDisabled) {","        throw new Error(\"Company is disabled\");","      }","    } else {","      throw new Error(\"forbidden\");","    }","","    const { error: authUpdateError } = await supabaseAdmin.auth.admin","      .updateUserById(target.id, { password: newPin });","    if (authUpdateError) throw new Error(authUpdateError.message);","","    const pinHash = await computePinHash(companyCode, username, newPin);","    const { error: updateError } = await supabaseAdmin","      .from(\"users\")","      .update({ pinHash, active: true })","      .eq(\"id\", target.id);","    if (updateError) throw new Error(updateError.message);","","    return json({ ok: true }, { headers: corsHeaders });","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});",""]}},{"name":"resolve_credential_reset_request","is_shared":false,"files":["supabase/functions/resolve_credential_reset_request/index.ts"],"index_file":"supabase/functions/resolve_credential_reset_request/index.ts","index_sha256":"ae9f4a924141d3b7b5fc63826f91b892efbf2585e3c3111d226587a9d7e754a6","synopsis":{"imports":["../_shared/cors.ts"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertCallerActive,","  assertPin,","  computePinHash,","  createAdminClient,","  getCallerContext,","  internalEmail,","  json,","  normalizeUsername,","} from \"../_shared/admin.ts\";","","function assertUuid(value: string, field: string): void {","  const v = (value ?? \"\").trim();","  const uuidRe =","    /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;","  if (!uuidRe.test(v)) throw new Error(`${field} must be a UUID`);","}","","type ResolveBody = {","  requestId?: string;","  approve?: boolean;","  newUsername?: string;","  newPin?: string;","};","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const supabaseAdmin = createAdminClient();","    const caller = await getCallerContext(supabaseAdmin, req);","    assertCallerActive(caller);","","    if (caller.role !== \"manager\" && caller.role !== \"platform_admin\") {","      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });","    }","","    const body = (await req.json()) as ResolveBody;","    const requestId = String(body.requestId ?? \"\").trim();","    assertUuid(requestId, \"requestId\");","    const approve = Boolean(body.approve);","","    const { data: requestRow, error: requestError } = await supabaseAdmin","[REDACTED LINE]","      .select(","        \"id, company_code, requested_by_user_id, target_user_id, request_type, status\",","      )","      .eq(\"id\", requestId)"],"tail":["          targetUser.companyCode,","          nextUsername,","          nextPin,","        );","      }","","      const { error: userUpdateError } = await supabaseAdmin","        .from(\"users\")","        .update(userUpdate)","        .eq(\"id\", targetUser.id);","      if (userUpdateError) throw new Error(userUpdateError.message);","    }","","    const { error: updateError } = await supabaseAdmin","[REDACTED LINE]","      .update({","        status: approve ? \"approved\" : \"denied\",","        resolved_at: new Date().toISOString(),","      })","      .eq(\"id\", requestRow.id);","    if (updateError) throw new Error(updateError.message);","","    return json({ ok: true }, { headers: corsHeaders });","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});"]}},{"name":"set_company_status","is_shared":false,"files":["supabase/functions/set_company_status/index.ts"],"index_file":"supabase/functions/set_company_status/index.ts","index_sha256":"f6c820a23c360dc3a00b829bab71b42c860ca2d8f026d24af80778cd4715d796","synopsis":{"imports":["../_shared/cors.ts"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertCallerActive,","  createAdminClient,","  getCallerContext,","  json,","  normalizeCompanyCode,","} from \"../_shared/admin.ts\";","","type StatusBody = {","  companyCode?: string;","  isDisabled?: boolean;","  reactivateUsers?: boolean;","};","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const supabaseAdmin = createAdminClient();","    const caller = await getCallerContext(supabaseAdmin, req);","    assertCallerActive(caller);","    if (caller.role !== \"platform_admin\") {","      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });","    }","","    const body = (await req.json()) as StatusBody;","    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));","    const isDisabled = Boolean(body.isDisabled);","    const reactivateUsers = Boolean(body.reactivateUsers);","","    if (companyCode === \"PLATFORM\" && isDisabled) {","      throw new Error(\"Cannot disable PLATFORM\");","    }","","    const { data: updated, error: updateError } = await supabaseAdmin","      .from(\"companies\")","      .update({ isDisabled })","      .eq(\"companyCode\", companyCode)","      .select('id, \"companyCode\", \"isDisabled\"');","    if (updateError) throw new Error(updateError.message);","    if (!updated || updated.length === 0) throw new Error(\"Company not found\");","","    if (isDisabled) {","      await supabaseAdmin.from(\"users\").update({ active: false }).eq(\"companyCode\", companyCode);","    } else if (reactivateUsers) {","      await supabaseAdmin.from(\"users\").update({ active: true }).eq(\"companyCode\", companyCode);","    }",""],"tail":["","    if (companyCode === \"PLATFORM\" && isDisabled) {","      throw new Error(\"Cannot disable PLATFORM\");","    }","","    const { data: updated, error: updateError } = await supabaseAdmin","      .from(\"companies\")","      .update({ isDisabled })","      .eq(\"companyCode\", companyCode)","      .select('id, \"companyCode\", \"isDisabled\"');","    if (updateError) throw new Error(updateError.message);","    if (!updated || updated.length === 0) throw new Error(\"Company not found\");","","    if (isDisabled) {","      await supabaseAdmin.from(\"users\").update({ active: false }).eq(\"companyCode\", companyCode);","    } else if (reactivateUsers) {","      await supabaseAdmin.from(\"users\").update({ active: true }).eq(\"companyCode\", companyCode);","    }","","    return json(","      { ok: true, companyCode, isDisabled, reactivateUsers },","      { headers: corsHeaders },","    );","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});"]}},{"name":"submit_change_request","is_shared":false,"files":["supabase/functions/submit_change_request/index.ts"],"index_file":"supabase/functions/submit_change_request/index.ts","index_sha256":"78a196ea84a4ebcc380a19f92c71a65eedc3dbac55633c768a594dd3ebdd6f4b","synopsis":{"imports":["../_shared/cors.ts","https://esm.sh/@supabase/supabase-js@2.49.1"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { createClient } from \"https://esm.sh/@supabase/supabase-js@2.49.1\";","import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertPin,","  getBearerToken,","  getEnv,","  json,","  normalizeUsername,","} from \"../_shared/admin.ts\";","","type SubmitBody = {","  proposedUsername?: string;","  proposedPin?: string;","};","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const body = (await req.json()) as SubmitBody;","    const proposedUsernameRaw = String(body.proposedUsername ?? \"\").trim();","    const proposedPinRaw = String(body.proposedPin ?? \"\").trim();","","    if (!proposedUsernameRaw && !proposedPinRaw) {","      throw new Error(\"proposedUsername or proposedPin is required\");","    }","","    let proposedUsername = \"\";","    if (proposedUsernameRaw) {","      proposedUsername = normalizeUsername(proposedUsernameRaw);","    }","","    let proposedPin = \"\";","    if (proposedPinRaw) {","      assertPin(proposedPinRaw, \"proposedPin\");","      proposedPin = proposedPinRaw;","    }","","    const url = getEnv(\"SUPABASE_URL\");","[REDACTED LINE]","    const token = getBearerToken(req);","","[REDACTED LINE]","      auth: { persistSession: false, autoRefreshToken: false },","      global: {","[REDACTED LINE]","      },","    });",""],"tail":["      throw new Error(\"Unsupported role\");","    }","","    const { data: inserted, error: insertError } = await supabase","      .from(\"requests\")","      .insert({","        companyCode: userRow.companyCode,","        type: requestType,","        status: \"pending\",","        requesterUserId: userRow.id,","        targetUserId: userRow.id,","        proposedUsername,","        proposedPin,","      })","      .select(\"id\")","      .single();","","    if (insertError) throw new Error(insertError.message);","","    return json(","      { ok: true, requestId: inserted.id, type: requestType },","      { headers: corsHeaders },","    );","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});"]}},{"name":"submit_credential_reset_request","is_shared":false,"files":["supabase/functions/submit_credential_reset_request/index.ts"],"index_file":"supabase/functions/submit_credential_reset_request/index.ts","index_sha256":"93296a7ad696dd1cac38f4875758d98cd4223184d639295cbcea881645df53c6","synopsis":{"imports":["../_shared/admin.ts","../_shared/cors.ts","https://esm.sh/@supabase/supabase-js@2.49.1"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { createClient } from \"https://esm.sh/@supabase/supabase-js@2.49.1\";","import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import { getBearerToken, getEnv, json } from \"../_shared/admin.ts\";","","type SubmitBody = {","  requestType?: string;","};","","const allowedTypes = new Set([\"username\", \"pin\", \"both\"]);","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const body = (await req.json()) as SubmitBody;","    const requestType = String(body.requestType ?? \"\").trim();","    if (!allowedTypes.has(requestType)) {","      throw new Error(\"requestType must be username, pin, or both\");","    }","","    const url = getEnv(\"SUPABASE_URL\");","[REDACTED LINE]","    const token = getBearerToken(req);","","[REDACTED LINE]","      auth: { persistSession: false, autoRefreshToken: false },","      global: {","[REDACTED LINE]","      },","    });","","    const { data: authData, error: authError } = await supabase.auth.getUser();","    if (authError || !authData?.user) throw new Error(\"Invalid auth token\");","","    const { data: userRow, error: userError } = await supabase","      .from(\"users\")","      .select('id, \"companyCode\", role, active')","      .eq(\"id\", authData.user.id)","      .single();","    if (userError || !userRow) throw new Error(\"User mapping not found\");","    if (!userRow.active) throw new Error(\"User is inactive\");","    if (userRow.role !== \"employee\") throw new Error(\"Only employees can submit reset requests\");","","    const { data: inserted, error: insertError } = await supabase","[REDACTED LINE]","      .insert({","        company_code: userRow.companyCode,","        requested_by_user_id: userRow.id,","        target_user_id: userRow.id,"],"tail":["    const { data: userRow, error: userError } = await supabase","      .from(\"users\")","      .select('id, \"companyCode\", role, active')","      .eq(\"id\", authData.user.id)","      .single();","    if (userError || !userRow) throw new Error(\"User mapping not found\");","    if (!userRow.active) throw new Error(\"User is inactive\");","    if (userRow.role !== \"employee\") throw new Error(\"Only employees can submit reset requests\");","","    const { data: inserted, error: insertError } = await supabase","[REDACTED LINE]","      .insert({","        company_code: userRow.companyCode,","        requested_by_user_id: userRow.id,","        target_user_id: userRow.id,","        request_type: requestType,","        status: \"pending\",","      })","      .select(\"id\")","      .single();","    if (insertError) throw new Error(insertError.message);","","    return json({ ok: true, requestId: inserted.id }, { headers: corsHeaders });","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});"]}},{"name":"terminate_company","is_shared":false,"files":["supabase/functions/terminate_company/index.ts"],"index_file":"supabase/functions/terminate_company/index.ts","index_sha256":"bf5d0f548563ba0826d2d816d89ca372d8c17b30eecb31037a14a3bfea0ea6ec","synopsis":{"imports":["../_shared/cors.ts"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertCallerActive,","  createAdminClient,","  getCallerContext,","  json,","  normalizeCompanyCode,","} from \"../_shared/admin.ts\";","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const supabaseAdmin = createAdminClient();","    const caller = await getCallerContext(supabaseAdmin, req);","    assertCallerActive(caller);","    if (caller.role !== \"platform_admin\") {","      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });","    }","","    const body = await req.json();","    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));","    if (companyCode === \"PLATFORM\") throw new Error(\"Cannot terminate PLATFORM\");","","    const { data: updated, error: updateError } = await supabaseAdmin","      .from(\"companies\")","      .update({ isDisabled: true })","      .eq(\"companyCode\", companyCode)","      .select('id, \"companyCode\", \"isDisabled\"');","    if (updateError) throw new Error(updateError.message);","    if (!updated || updated.length === 0) throw new Error(\"Company not found\");","","    await supabaseAdmin","      .from(\"users\")","      .update({ active: false })","      .eq(\"companyCode\", companyCode);","","    return json({ ok: true }, { headers: corsHeaders });","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});",""],"tail":["    if (caller.role !== \"platform_admin\") {","      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });","    }","","    const body = await req.json();","    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));","    if (companyCode === \"PLATFORM\") throw new Error(\"Cannot terminate PLATFORM\");","","    const { data: updated, error: updateError } = await supabaseAdmin","      .from(\"companies\")","      .update({ isDisabled: true })","      .eq(\"companyCode\", companyCode)","      .select('id, \"companyCode\", \"isDisabled\"');","    if (updateError) throw new Error(updateError.message);","    if (!updated || updated.length === 0) throw new Error(\"Company not found\");","","    await supabaseAdmin","      .from(\"users\")","      .update({ active: false })","      .eq(\"companyCode\", companyCode);","","    return json({ ok: true }, { headers: corsHeaders });","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});",""]}},{"name":"update_admin_credentials","is_shared":false,"files":["supabase/functions/update_admin_credentials/index.ts"],"index_file":"supabase/functions/update_admin_credentials/index.ts","index_sha256":"7f41f17615d7fa0fc60ca84f0c90091a0f8bdb39cf4d6b53b2e6fa3730a812af","synopsis":{"imports":["../_shared/cors.ts"],"exported_handler":"Deno.serve","required_env_vars":[]},"snippets":{"head":["import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";","import {","  assertCallerActive,","  assertPin,","  computePinHash,","  createAdminClient,","  getCallerContext,","  internalEmail,","  json,","  normalizeUsername,","} from \"../_shared/admin.ts\";","","type UpdateBody = {","  newUsername?: string;","  newPin?: string;","};","","Deno.serve(async (req) => {","  const preflight = handleOptions(req);","  if (preflight) return preflight;","","  try {","    const supabaseAdmin = createAdminClient();","    const caller = await getCallerContext(supabaseAdmin, req);","    assertCallerActive(caller);","    if (caller.role !== \"platform_admin\") {","      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });","    }","","    const body = (await req.json()) as UpdateBody;","    const newUsernameRaw = String(body.newUsername ?? \"\").trim();","    const newPinRaw = String(body.newPin ?? \"\").trim();","","    if (!newUsernameRaw && !newPinRaw) {","      throw new Error(\"newUsername or newPin is required\");","    }","","    const { data: currentUser, error: currentError } = await supabaseAdmin","      .from(\"users\")","      .select('id, \"companyCode\", username')","      .eq(\"id\", caller.authUserId)","      .single();","    if (currentError || !currentUser) throw new Error(\"User mapping not found\");","","    const companyCode = currentUser.companyCode;","    const currentUsername = currentUser.username;","    const nextUsername = newUsernameRaw","      ? normalizeUsername(newUsernameRaw)","      : currentUsername;",""],"tail":["      const { error: authError } = await supabaseAdmin.auth.admin.updateUserById(","        currentUser.id,","        authUpdate,","      );","      if (authError) throw new Error(authError.message);","    }","","    const userUpdate: Record<string, unknown> = { active: true };","    if (nextUsername !== currentUsername) userUpdate.username = nextUsername;","    if (nextPin) {","      userUpdate.pinHash = await computePinHash(companyCode, nextUsername, nextPin);","    }","","    const { error: updateError } = await supabaseAdmin","      .from(\"users\")","      .update(userUpdate)","      .eq(\"id\", currentUser.id);","    if (updateError) throw new Error(updateError.message);","","    return json(","      { ok: true, username: nextUsername, companyCode },","      { headers: corsHeaders },","    );","  } catch (e) {","    return json(","      { error: e instanceof Error ? e.message : String(e) },","      { status: 400, headers: corsHeaders },","    );","  }","});"]}}]}