{
  "functions": {
    "approve_request": {
      "path": "supabase/functions/approve_request/index.ts",
      "sha256": "79dadc71e94f1f050fce8af598c652490a6fa2c709dd20af797986702a07a96d",
      "exports": [],
      "expected_inputs": [],
      "expected_outputs": [],
      "first_50_lines": [
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertCallerActive,",
        "  assertPin,",
        "  computePinHash,",
        "  createAdminClient,",
        "  getCallerContext,",
        "  internalEmail,",
        "  json,",
        "  normalizeUsername,",
        "} from \"../_shared/admin.ts\";",
        "",
        "function assertUuid(value: string, field: string): void {",
        "  const v = (value ?? \"\").trim();",
        "  const uuidRe =",
        "    /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;",
        "  if (!uuidRe.test(v)) throw new Error(`${field} must be a UUID`);",
        "}",
        "",
        "function appendDecisionNote(existing: string | null, decisionNote: string): string {",
        "  const trimmed = (decisionNote ?? \"\").trim();",
        "  const line = `Decision: ${trimmed}`;",
        "  return existing && existing.trim().length > 0 ? `${existing}\\n${line}` : line;",
        "}",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const supabaseAdmin = createAdminClient();",
        "    const caller = await getCallerContext(supabaseAdmin, req);",
        "    assertCallerActive(caller);",
        "",
        "    const body = await req.json();",
        "    const requestId = String(body.requestId ?? \"\").trim();",
        "    assertUuid(requestId, \"requestId\");",
        "    const decisionNote = String(body.decisionNote ?? \"\").trim();",
        "",
        "    const { data: requestRow, error: requestError } = await supabaseAdmin",
        "      .from(\"requests\")",
        "      .select(",
        "        'id, \"companyCode\", type, status, \"requesterUserId\", \"targetUserId\", \"proposedUsername\", \"proposedPin\", \"decisionNote\"',",
        "      )",
        "      .eq(\"id\", requestId)",
        "      .single();",
        "    if (requestError) throw new Error(requestError.message);",
        "    if (requestRow.status !== \"pending\") throw new Error(\"Request is not pending\");",
        "",
        "    const requestType: string = requestRow.type;"
      ],
      "has_deno_serve": true
    },
    "auth_login": {
      "path": "supabase/functions/auth_login/index.ts",
      "sha256": "1a53be81c7a846a7771abaf7f197a7213b671c247a8998b51c49bde26dab7f0b",
      "exports": [],
      "expected_inputs": [
        "companyCode",
        "email",
        "pin",
        "username"
      ],
      "expected_outputs": [],
      "first_50_lines": [
        "import { createClient } from \"https://esm.sh/@supabase/supabase-js@2.49.1\";",
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertPin,",
        "  createAdminClient,",
        "  getEnv,",
        "  internalEmail,",
        "  json,",
        "  normalizeCompanyCode,",
        "  normalizeUsername,",
        "} from \"../_shared/admin.ts\";",
        "",
        "type LoginBody = {",
        "  companyCode?: string;",
        "  username?: string;",
        "  email?: string;",
        "  pin?: string;",
        "};",
        "",
        "function normalizeEmail(value: string): string {",
        "  const email = String(value ?? \"\").trim();",
        "  if (!email || !email.includes(\"@\")) throw new Error(\"email is required\");",
        "  return email.toLowerCase();",
        "}",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const body = (await req.json()) as LoginBody;",
        "    const pin = String(body.pin ?? \"\").trim();",
        "    assertPin(pin, \"pin\");",
        "",
        "    let email = \"\";",
        "    if (body.email) {",
        "      email = normalizeEmail(body.email);",
        "    } else {",
        "      const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));",
        "      const username = normalizeUsername(String(body.username ?? \"\"));",
        "      email = internalEmail(companyCode, username).toLowerCase();",
        "    }",
        "",
        "    const url = getEnv(\"SUPABASE_URL\");",
        "    const anonKey = getEnv(\"SUPABASE_ANON_KEY\");",
        "    const supabase = createClient(url, anonKey, {",
        "      auth: { persistSession: false, autoRefreshToken: false },",
        "      global: { headers: { \"X-Client-Info\": \"schedule-manager-edge\" } },",
        "    });",
        ""
      ],
      "has_deno_serve": true
    },
    "bootstrap_platform_admin": {
      "path": "supabase/functions/bootstrap_platform_admin/index.ts",
      "sha256": "67127f3cab655cecba5dd87a35fd7c710d44926c573582b087453c9bdaf355ca",
      "exports": [],
      "expected_inputs": [
        "pin",
        "token",
        "username"
      ],
      "expected_outputs": [],
      "first_50_lines": [
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertPin,",
        "  computePinHash,",
        "  createAdminClient,",
        "  internalEmail,",
        "  json,",
        "  normalizeUsername,",
        "} from \"../_shared/admin.ts\";",
        "",
        "function getEnv(name: string): string {",
        "  const value = Deno.env.get(name);",
        "  if (!value) throw new Error(`Missing env var: ${name}`);",
        "  return value;",
        "}",
        "",
        "type BootstrapBody = {",
        "  token?: string;",
        "  username?: string;",
        "  pin?: string;",
        "};",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const supabaseAdmin = createAdminClient();",
        "",
        "    const body = (await req.json()) as BootstrapBody;",
        "    const token = String(body.token ?? \"\").trim();",
        "    const expected = getEnv(\"BOOTSTRAP_TOKEN\");",
        "    if (!token || token !== expected) {",
        "      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });",
        "    }",
        "",
        "    const { data: existingAdmins, error: existingError } = await supabaseAdmin",
        "      .from(\"users\")",
        "      .select(\"id\")",
        "      .eq(\"role\", \"platform_admin\")",
        "      .limit(1);",
        "    if (existingError) throw new Error(existingError.message);",
        "    if ((existingAdmins ?? []).length > 0) {",
        "      return json(",
        "        { error: \"platform_admin already exists\" },",
        "        { status: 409, headers: corsHeaders },",
        "      );",
        "    }",
        "",
        "    const companyCode = \"PLATFORM\";"
      ],
      "has_deno_serve": true
    },
    "create_company_with_manager": {
      "path": "supabase/functions/create_company_with_manager/index.ts",
      "sha256": "a51fb41748076cb841e49c341ee13dff945766d31d7e9e3b2eac459208d5435e",
      "exports": [],
      "expected_inputs": [],
      "expected_outputs": [],
      "first_50_lines": [
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertCallerActive,",
        "  assertPin,",
        "  computePinHash,",
        "  createAdminClient,",
        "  getCallerContext,",
        "  internalEmail,",
        "  json,",
        "  normalizeCompanyCode,",
        "  normalizeUsername,",
        "} from \"../_shared/admin.ts\";",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const supabaseAdmin = createAdminClient();",
        "    const caller = await getCallerContext(supabaseAdmin, req);",
        "    assertCallerActive(caller);",
        "    if (caller.role !== \"platform_admin\") {",
        "      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });",
        "    }",
        "",
        "    const body = await req.json();",
        "    const companyName = String(body.companyName ?? \"\").trim();",
        "    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));",
        "    const managerUsername = normalizeUsername(String(body.managerUsername ?? \"\"));",
        "    const managerPin = String(body.managerPin ?? \"\").trim();",
        "    assertPin(managerPin, \"managerPin\");",
        "    if (!companyName) throw new Error(\"companyName is required\");",
        "",
        "    const { data: insertedCompany, error: companyError } = await supabaseAdmin",
        "      .from(\"companies\")",
        "      .insert({",
        "        companyCode,",
        "        companyName,",
        "        isDisabled: false,",
        "        supportEnabled: false,",
        "      })",
        "      .select('id, \"companyCode\"')",
        "      .single();",
        "",
        "    if (companyError) throw new Error(companyError.message);",
        "",
        "    const email = internalEmail(companyCode, managerUsername);",
        "    const { data: authCreate, error: authError } = await supabaseAdmin.auth",
        "      .admin.createUser({",
        "        email,"
      ],
      "has_deno_serve": true
    },
    "create_employee_login": {
      "path": "supabase/functions/create_employee_login/index.ts",
      "sha256": "1cf1527e82c1bdc4c3684cfd61339ea0c5b81dd33d94f1526b89288392c3641b",
      "exports": [],
      "expected_inputs": [],
      "expected_outputs": [],
      "first_50_lines": [
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertCallerActive,",
        "  assertPin,",
        "  computePinHash,",
        "  createAdminClient,",
        "  getCallerContext,",
        "  internalEmail,",
        "  json,",
        "  normalizeCompanyCode,",
        "  normalizeUsername,",
        "} from \"../_shared/admin.ts\";",
        "",
        "function assertUuid(value: string, field: string): void {",
        "  const v = (value ?? \"\").trim();",
        "  const uuidRe =",
        "    /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;",
        "  if (!uuidRe.test(v)) throw new Error(`${field} must be a UUID`);",
        "}",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const supabaseAdmin = createAdminClient();",
        "    const caller = await getCallerContext(supabaseAdmin, req);",
        "    assertCallerActive(caller);",
        "    if (caller.role !== \"manager\") {",
        "      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });",
        "    }",
        "",
        "    const body = await req.json();",
        "    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));",
        "    if (companyCode !== caller.companyCode) {",
        "      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });",
        "    }",
        "",
        "    const { data: companyRow, error: companyError } = await supabaseAdmin",
        "      .from(\"companies\")",
        "      .select('\"isDisabled\"')",
        "      .eq(\"companyCode\", companyCode)",
        "      .maybeSingle();",
        "    if (companyError) throw new Error(companyError.message);",
        "    if (!companyRow) throw new Error(\"Company not found\");",
        "    if (companyRow.isDisabled) throw new Error(\"Company is disabled\");",
        "",
        "    const employeeId = String(body.employeeId ?? \"\").trim();",
        "    assertUuid(employeeId, \"employeeId\");",
        ""
      ],
      "has_deno_serve": true
    },
    "create_manager_account": {
      "path": "supabase/functions/create_manager_account/index.ts",
      "sha256": "1502e3070bff7a07e8940ffd8dbd2c68e5a83a16e1202a227f416878b7b2eacb",
      "exports": [],
      "expected_inputs": [
        "companyCode",
        "managerPin",
        "managerUsername"
      ],
      "expected_outputs": [],
      "first_50_lines": [
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertCallerActive,",
        "  assertPin,",
        "  computePinHash,",
        "  createAdminClient,",
        "  getCallerContext,",
        "  internalEmail,",
        "  json,",
        "  normalizeCompanyCode,",
        "  normalizeUsername,",
        "} from \"../_shared/admin.ts\";",
        "",
        "type CreateBody = {",
        "  companyCode?: string;",
        "  managerUsername?: string;",
        "  managerPin?: string;",
        "};",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const supabaseAdmin = createAdminClient();",
        "    const caller = await getCallerContext(supabaseAdmin, req);",
        "    assertCallerActive(caller);",
        "    if (caller.role !== \"platform_admin\") {",
        "      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });",
        "    }",
        "",
        "    const body = (await req.json()) as CreateBody;",
        "    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));",
        "    const managerUsername = normalizeUsername(String(body.managerUsername ?? \"\"));",
        "    const managerPin = String(body.managerPin ?? \"\").trim();",
        "    assertPin(managerPin, \"managerPin\");",
        "",
        "    const { data: company, error: companyError } = await supabaseAdmin",
        "      .from(\"companies\")",
        "      .select('\"companyCode\", \"isDisabled\"')",
        "      .eq(\"companyCode\", companyCode)",
        "      .maybeSingle();",
        "    if (companyError) throw new Error(companyError.message);",
        "    if (!company) throw new Error(\"Company not found\");",
        "    if (company.isDisabled) throw new Error(\"Company is disabled\");",
        "",
        "    const { data: existing, error: existingError } = await supabaseAdmin",
        "      .from(\"users\")",
        "      .select(\"id\")",
        "      .eq(\"companyCode\", companyCode)"
      ],
      "has_deno_serve": true
    },
    "deny_request": {
      "path": "supabase/functions/deny_request/index.ts",
      "sha256": "1779057f779e7ad2af0490f4230896c6f44cc78900ba22ccfc95e18320e2097b",
      "exports": [],
      "expected_inputs": [],
      "expected_outputs": [],
      "first_50_lines": [
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertCallerActive,",
        "  createAdminClient,",
        "  getCallerContext,",
        "  json,",
        "} from \"../_shared/admin.ts\";",
        "",
        "function assertUuid(value: string, field: string): void {",
        "  const v = (value ?? \"\").trim();",
        "  const uuidRe =",
        "    /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;",
        "  if (!uuidRe.test(v)) throw new Error(`${field} must be a UUID`);",
        "}",
        "",
        "function appendDecisionNote(existing: string | null, decisionNote: string): string {",
        "  const trimmed = (decisionNote ?? \"\").trim();",
        "  const line = `Decision: ${trimmed}`;",
        "  return existing && existing.trim().length > 0 ? `${existing}\\n${line}` : line;",
        "}",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const supabaseAdmin = createAdminClient();",
        "    const caller = await getCallerContext(supabaseAdmin, req);",
        "    assertCallerActive(caller);",
        "",
        "    const body = await req.json();",
        "    const requestId = String(body.requestId ?? \"\").trim();",
        "    assertUuid(requestId, \"requestId\");",
        "    const decisionNote = String(body.decisionNote ?? \"\").trim();",
        "",
        "    const { data: requestRow, error: requestError } = await supabaseAdmin",
        "      .from(\"requests\")",
        "      .select('id, \"companyCode\", type, status, \"decisionNote\"')",
        "      .eq(\"id\", requestId)",
        "      .single();",
        "    if (requestError) throw new Error(requestError.message);",
        "    if (requestRow.status !== \"pending\") throw new Error(\"Request is not pending\");",
        "",
        "    const requestType: string = requestRow.type;",
        "    if (requestType === \"employee_change_credentials\") {",
        "      if (caller.role !== \"manager\") throw new Error(\"forbidden\");",
        "      if (requestRow.companyCode !== caller.companyCode) throw new Error(\"forbidden\");",
        "    } else if (requestType === \"manager_change_credentials\") {",
        "      if (caller.role !== \"platform_admin\") throw new Error(\"forbidden\");",
        "    } else if (requestType === \"admin_change_credentials\") {"
      ],
      "has_deno_serve": true
    },
    "reset_user_pin": {
      "path": "supabase/functions/reset_user_pin/index.ts",
      "sha256": "acb648755f1bddffd18b0949873d8de24485436e1da7913a163b7dcaad8065c0",
      "exports": [],
      "expected_inputs": [],
      "expected_outputs": [],
      "first_50_lines": [
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertCallerActive,",
        "  assertPin,",
        "  computePinHash,",
        "  createAdminClient,",
        "  getCallerContext,",
        "  json,",
        "  normalizeCompanyCode,",
        "  normalizeUsername,",
        "} from \"../_shared/admin.ts\";",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const supabaseAdmin = createAdminClient();",
        "    const caller = await getCallerContext(supabaseAdmin, req);",
        "    assertCallerActive(caller);",
        "",
        "    const body = await req.json();",
        "    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));",
        "    const username = normalizeUsername(String(body.username ?? \"\"));",
        "    const newPin = String(body.newPin ?? \"\").trim();",
        "    assertPin(newPin, \"newPin\");",
        "",
        "    const { data: target, error: targetError } = await supabaseAdmin",
        "      .from(\"users\")",
        "      .select('id, role, \"companyCode\", username')",
        "      .eq(\"companyCode\", companyCode)",
        "      .eq(\"username\", username)",
        "      .maybeSingle();",
        "    if (targetError) throw new Error(targetError.message);",
        "    if (!target) throw new Error(\"User not found\");",
        "",
        "    if (caller.role === \"platform_admin\") {",
        "      if (target.role !== \"manager\") throw new Error(\"forbidden\");",
        "    } else if (caller.role === \"manager\") {",
        "      if (companyCode !== caller.companyCode) throw new Error(\"forbidden\");",
        "      if (target.role !== \"employee\") throw new Error(\"forbidden\");",
        "",
        "      const { data: companyRow, error: companyError } = await supabaseAdmin",
        "        .from(\"companies\")",
        "        .select('\"isDisabled\"')",
        "        .eq(\"companyCode\", companyCode)",
        "        .maybeSingle();",
        "      if (companyError) throw new Error(companyError.message);",
        "      if (!companyRow || companyRow.isDisabled) {",
        "        throw new Error(\"Company is disabled\");"
      ],
      "has_deno_serve": true
    },
    "resolve_credential_reset_request": {
      "path": "supabase/functions/resolve_credential_reset_request/index.ts",
      "sha256": "ae9f4a924141d3b7b5fc63826f91b892efbf2585e3c3111d226587a9d7e754a6",
      "exports": [],
      "expected_inputs": [
        "approve",
        "newPin",
        "newUsername",
        "requestId"
      ],
      "expected_outputs": [],
      "first_50_lines": [
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertCallerActive,",
        "  assertPin,",
        "  computePinHash,",
        "  createAdminClient,",
        "  getCallerContext,",
        "  internalEmail,",
        "  json,",
        "  normalizeUsername,",
        "} from \"../_shared/admin.ts\";",
        "",
        "function assertUuid(value: string, field: string): void {",
        "  const v = (value ?? \"\").trim();",
        "  const uuidRe =",
        "    /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;",
        "  if (!uuidRe.test(v)) throw new Error(`${field} must be a UUID`);",
        "}",
        "",
        "type ResolveBody = {",
        "  requestId?: string;",
        "  approve?: boolean;",
        "  newUsername?: string;",
        "  newPin?: string;",
        "};",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const supabaseAdmin = createAdminClient();",
        "    const caller = await getCallerContext(supabaseAdmin, req);",
        "    assertCallerActive(caller);",
        "",
        "    if (caller.role !== \"manager\" && caller.role !== \"platform_admin\") {",
        "      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });",
        "    }",
        "",
        "    const body = (await req.json()) as ResolveBody;",
        "    const requestId = String(body.requestId ?? \"\").trim();",
        "    assertUuid(requestId, \"requestId\");",
        "    const approve = Boolean(body.approve);",
        "",
        "    const { data: requestRow, error: requestError } = await supabaseAdmin",
        "      .from(\"credential_reset_requests\")",
        "      .select(",
        "        \"id, company_code, requested_by_user_id, target_user_id, request_type, status\",",
        "      )",
        "      .eq(\"id\", requestId)"
      ],
      "has_deno_serve": true
    },
    "set_company_status": {
      "path": "supabase/functions/set_company_status/index.ts",
      "sha256": "f6c820a23c360dc3a00b829bab71b42c860ca2d8f026d24af80778cd4715d796",
      "exports": [],
      "expected_inputs": [
        "companyCode",
        "isDisabled",
        "reactivateUsers"
      ],
      "expected_outputs": [],
      "first_50_lines": [
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertCallerActive,",
        "  createAdminClient,",
        "  getCallerContext,",
        "  json,",
        "  normalizeCompanyCode,",
        "} from \"../_shared/admin.ts\";",
        "",
        "type StatusBody = {",
        "  companyCode?: string;",
        "  isDisabled?: boolean;",
        "  reactivateUsers?: boolean;",
        "};",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const supabaseAdmin = createAdminClient();",
        "    const caller = await getCallerContext(supabaseAdmin, req);",
        "    assertCallerActive(caller);",
        "    if (caller.role !== \"platform_admin\") {",
        "      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });",
        "    }",
        "",
        "    const body = (await req.json()) as StatusBody;",
        "    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));",
        "    const isDisabled = Boolean(body.isDisabled);",
        "    const reactivateUsers = Boolean(body.reactivateUsers);",
        "",
        "    if (companyCode === \"PLATFORM\" && isDisabled) {",
        "      throw new Error(\"Cannot disable PLATFORM\");",
        "    }",
        "",
        "    const { data: updated, error: updateError } = await supabaseAdmin",
        "      .from(\"companies\")",
        "      .update({ isDisabled })",
        "      .eq(\"companyCode\", companyCode)",
        "      .select('id, \"companyCode\", \"isDisabled\"');",
        "    if (updateError) throw new Error(updateError.message);",
        "    if (!updated || updated.length === 0) throw new Error(\"Company not found\");",
        "",
        "    if (isDisabled) {",
        "      await supabaseAdmin.from(\"users\").update({ active: false }).eq(\"companyCode\", companyCode);",
        "    } else if (reactivateUsers) {",
        "      await supabaseAdmin.from(\"users\").update({ active: true }).eq(\"companyCode\", companyCode);",
        "    }",
        ""
      ],
      "has_deno_serve": true
    },
    "submit_change_request": {
      "path": "supabase/functions/submit_change_request/index.ts",
      "sha256": "78a196ea84a4ebcc380a19f92c71a65eedc3dbac55633c768a594dd3ebdd6f4b",
      "exports": [],
      "expected_inputs": [
        "proposedPin",
        "proposedUsername"
      ],
      "expected_outputs": [],
      "first_50_lines": [
        "import { createClient } from \"https://esm.sh/@supabase/supabase-js@2.49.1\";",
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertPin,",
        "  getBearerToken,",
        "  getEnv,",
        "  json,",
        "  normalizeUsername,",
        "} from \"../_shared/admin.ts\";",
        "",
        "type SubmitBody = {",
        "  proposedUsername?: string;",
        "  proposedPin?: string;",
        "};",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const body = (await req.json()) as SubmitBody;",
        "    const proposedUsernameRaw = String(body.proposedUsername ?? \"\").trim();",
        "    const proposedPinRaw = String(body.proposedPin ?? \"\").trim();",
        "",
        "    if (!proposedUsernameRaw && !proposedPinRaw) {",
        "      throw new Error(\"proposedUsername or proposedPin is required\");",
        "    }",
        "",
        "    let proposedUsername = \"\";",
        "    if (proposedUsernameRaw) {",
        "      proposedUsername = normalizeUsername(proposedUsernameRaw);",
        "    }",
        "",
        "    let proposedPin = \"\";",
        "    if (proposedPinRaw) {",
        "      assertPin(proposedPinRaw, \"proposedPin\");",
        "      proposedPin = proposedPinRaw;",
        "    }",
        "",
        "    const url = getEnv(\"SUPABASE_URL\");",
        "    const anonKey = getEnv(\"SUPABASE_ANON_KEY\");",
        "    const token = getBearerToken(req);",
        "",
        "    const supabase = createClient(url, anonKey, {",
        "      auth: { persistSession: false, autoRefreshToken: false },",
        "      global: {",
        "        headers: { Authorization: `Bearer ${token}`, \"X-Client-Info\": \"schedule-manager-edge\" },",
        "      },",
        "    });",
        ""
      ],
      "has_deno_serve": true
    },
    "submit_credential_reset_request": {
      "path": "supabase/functions/submit_credential_reset_request/index.ts",
      "sha256": "93296a7ad696dd1cac38f4875758d98cd4223184d639295cbcea881645df53c6",
      "exports": [],
      "expected_inputs": [
        "requestType"
      ],
      "expected_outputs": [],
      "first_50_lines": [
        "import { createClient } from \"https://esm.sh/@supabase/supabase-js@2.49.1\";",
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import { getBearerToken, getEnv, json } from \"../_shared/admin.ts\";",
        "",
        "type SubmitBody = {",
        "  requestType?: string;",
        "};",
        "",
        "const allowedTypes = new Set([\"username\", \"pin\", \"both\"]);",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const body = (await req.json()) as SubmitBody;",
        "    const requestType = String(body.requestType ?? \"\").trim();",
        "    if (!allowedTypes.has(requestType)) {",
        "      throw new Error(\"requestType must be username, pin, or both\");",
        "    }",
        "",
        "    const url = getEnv(\"SUPABASE_URL\");",
        "    const anonKey = getEnv(\"SUPABASE_ANON_KEY\");",
        "    const token = getBearerToken(req);",
        "",
        "    const supabase = createClient(url, anonKey, {",
        "      auth: { persistSession: false, autoRefreshToken: false },",
        "      global: {",
        "        headers: { Authorization: `Bearer ${token}`, \"X-Client-Info\": \"schedule-manager-edge\" },",
        "      },",
        "    });",
        "",
        "    const { data: authData, error: authError } = await supabase.auth.getUser();",
        "    if (authError || !authData?.user) throw new Error(\"Invalid auth token\");",
        "",
        "    const { data: userRow, error: userError } = await supabase",
        "      .from(\"users\")",
        "      .select('id, \"companyCode\", role, active')",
        "      .eq(\"id\", authData.user.id)",
        "      .single();",
        "    if (userError || !userRow) throw new Error(\"User mapping not found\");",
        "    if (!userRow.active) throw new Error(\"User is inactive\");",
        "    if (userRow.role !== \"employee\") throw new Error(\"Only employees can submit reset requests\");",
        "",
        "    const { data: inserted, error: insertError } = await supabase",
        "      .from(\"credential_reset_requests\")",
        "      .insert({",
        "        company_code: userRow.companyCode,",
        "        requested_by_user_id: userRow.id,",
        "        target_user_id: userRow.id,"
      ],
      "has_deno_serve": true
    },
    "terminate_company": {
      "path": "supabase/functions/terminate_company/index.ts",
      "sha256": "bf5d0f548563ba0826d2d816d89ca372d8c17b30eecb31037a14a3bfea0ea6ec",
      "exports": [],
      "expected_inputs": [],
      "expected_outputs": [],
      "first_50_lines": [
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertCallerActive,",
        "  createAdminClient,",
        "  getCallerContext,",
        "  json,",
        "  normalizeCompanyCode,",
        "} from \"../_shared/admin.ts\";",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const supabaseAdmin = createAdminClient();",
        "    const caller = await getCallerContext(supabaseAdmin, req);",
        "    assertCallerActive(caller);",
        "    if (caller.role !== \"platform_admin\") {",
        "      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });",
        "    }",
        "",
        "    const body = await req.json();",
        "    const companyCode = normalizeCompanyCode(String(body.companyCode ?? \"\"));",
        "    if (companyCode === \"PLATFORM\") throw new Error(\"Cannot terminate PLATFORM\");",
        "",
        "    const { data: updated, error: updateError } = await supabaseAdmin",
        "      .from(\"companies\")",
        "      .update({ isDisabled: true })",
        "      .eq(\"companyCode\", companyCode)",
        "      .select('id, \"companyCode\", \"isDisabled\"');",
        "    if (updateError) throw new Error(updateError.message);",
        "    if (!updated || updated.length === 0) throw new Error(\"Company not found\");",
        "",
        "    await supabaseAdmin",
        "      .from(\"users\")",
        "      .update({ active: false })",
        "      .eq(\"companyCode\", companyCode);",
        "",
        "    return json({ ok: true }, { headers: corsHeaders });",
        "  } catch (e) {",
        "    return json(",
        "      { error: e instanceof Error ? e.message : String(e) },",
        "      { status: 400, headers: corsHeaders },",
        "    );",
        "  }",
        "});",
        ""
      ],
      "has_deno_serve": true
    },
    "update_admin_credentials": {
      "path": "supabase/functions/update_admin_credentials/index.ts",
      "sha256": "7f41f17615d7fa0fc60ca84f0c90091a0f8bdb39cf4d6b53b2e6fa3730a812af",
      "exports": [],
      "expected_inputs": [
        "newPin",
        "newUsername"
      ],
      "expected_outputs": [],
      "first_50_lines": [
        "import { corsHeaders, handleOptions } from \"../_shared/cors.ts\";",
        "import {",
        "  assertCallerActive,",
        "  assertPin,",
        "  computePinHash,",
        "  createAdminClient,",
        "  getCallerContext,",
        "  internalEmail,",
        "  json,",
        "  normalizeUsername,",
        "} from \"../_shared/admin.ts\";",
        "",
        "type UpdateBody = {",
        "  newUsername?: string;",
        "  newPin?: string;",
        "};",
        "",
        "Deno.serve(async (req) => {",
        "  const preflight = handleOptions(req);",
        "  if (preflight) return preflight;",
        "",
        "  try {",
        "    const supabaseAdmin = createAdminClient();",
        "    const caller = await getCallerContext(supabaseAdmin, req);",
        "    assertCallerActive(caller);",
        "    if (caller.role !== \"platform_admin\") {",
        "      return json({ error: \"forbidden\" }, { status: 403, headers: corsHeaders });",
        "    }",
        "",
        "    const body = (await req.json()) as UpdateBody;",
        "    const newUsernameRaw = String(body.newUsername ?? \"\").trim();",
        "    const newPinRaw = String(body.newPin ?? \"\").trim();",
        "",
        "    if (!newUsernameRaw && !newPinRaw) {",
        "      throw new Error(\"newUsername or newPin is required\");",
        "    }",
        "",
        "    const { data: currentUser, error: currentError } = await supabaseAdmin",
        "      .from(\"users\")",
        "      .select('id, \"companyCode\", username')",
        "      .eq(\"id\", caller.authUserId)",
        "      .single();",
        "    if (currentError || !currentUser) throw new Error(\"User mapping not found\");",
        "",
        "    const companyCode = currentUser.companyCode;",
        "    const currentUsername = currentUser.username;",
        "    const nextUsername = newUsernameRaw",
        "      ? normalizeUsername(newUsernameRaw)",
        "      : currentUsername;",
        ""
      ],
      "has_deno_serve": true
    }
  },
  "migrations": [
    {
      "path": "supabase/migrations/0001_schema.sql",
      "sha256": "a4023a996dad7f880afc9295558b29f42870fad6a0f931cf4f15041b3d012bce"
    },
    {
      "path": "supabase/migrations/0002_rls_policies.sql",
      "sha256": "da9ae15405671132982a35c753e328c4884b5d55c21b9c27cee4c3195aac4e09"
    },
    {
      "path": "supabase/migrations/20251218060620_backend_foundation_company_code.sql",
      "sha256": "acb3411b4f3d4f272c94df88a693f0af5b583396f762ebd8abe99f102cf3b8df"
    },
    {
      "path": "supabase/migrations/20251218060919_backend_foundation_rls_policies.sql",
      "sha256": "6b2358d19a329d3eeb8dc093d70842a43a465ee6b38614bdcfc11c3070f942e3"
    },
    {
      "path": "supabase/migrations/20251218061853_backend_foundation_tenant_columns.sql",
      "sha256": "499a769aa2133b3333301008fee30abaa524c4f219d8f6aff1dd35f0de9609b5"
    },
    {
      "path": "supabase/migrations/20251219043316_cleanup_platform_admin_platform.sql",
      "sha256": "047951e72fbbbfbe7824c4b51bdb4bd913dd69ef7c621fad3c62e20a5c2d7877"
    },
    {
      "path": "supabase/migrations/20251219090000_platform_admin_break_glass_recovery.sql",
      "sha256": "e43466c85066351283b9d74ecb40d17419879399020d959f7432cd3c03555ddf"
    },
    {
      "path": "supabase/migrations/20251221015020_phase2_build.sql",
      "sha256": "187e5b7a3872b6bd66198380b966db1e5e31c66f393edd1fd6bc2340f184111f"
    }
  ],
  "config_files": [
    {
      "path": "supabase/config.toml",
      "sha256": "72010c2975dfbde273ac2d704dcccb89d742b5a7c8ab7cbe9f08ca084dd5d494"
    }
  ],
  "seed_files": [
    {
      "path": "supabase/seed.sql",
      "sha256": "acf5e98265e4f4dacc43558ddd89ec57b047e16284009e191eeeaa3cc345ce35"
    }
  ],
  "shared_modules": [
    "supabase/functions/_shared"
  ],
  "naming": {
    "camelCase": 1409,
    "snake_case": 1527,
    "mixed_or_other": 11994,
    "notes": [
      "Both camelCase and snake_case identifiers detected in local files."
    ]
  },
  "notes": []
}