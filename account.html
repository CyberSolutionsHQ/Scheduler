<!doctype html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0e1520">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Account • Cyber Solutions LLC Schedule Manager</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <header class="header">
    <div class="title">
      <div>
        <h1 class="h1">Cyber Solutions LLC Schedule Manager</h1>
        <div class="sub">Manager account</div>
      </div>
    </div>

    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="employees.html">Employees</a>
      <a href="locations.html">Locations</a>
      <a href="jobs.html">Jobs</a>
      <a href="shifts.html">Shifts</a>
      <a href="crews.html">Crews</a>
      <a href="export.html">Export PDFs</a>
      <a href="users.html">Users / Access</a>
      <a href="employee-requests.html">Employee Requests <span class="badge" data-badge="employeeRequests" style="display:none;"></span></a>
      <a class="active" href="account.html">My Account</a>
      <a href="settings.html">Settings</a>
    </nav>
  </header>

  <div class="container">
    <section class="card">
      <h2>My Account</h2>
      <div class="small" id="accountMeta">Loading…</div>
    </section>

    <section class="card">
      <h2>Request username / PIN change</h2>
      <form id="requestForm" autocomplete="off">
        <label for="newUsername">Requested new username (optional)</label>
        <input id="newUsername" placeholder="Leave blank to keep current username" autocomplete="username" autocapitalize="none" />

        <label for="newPin">Requested new 4-digit PIN (optional)</label>
        <input id="newPin" type="password" inputmode="numeric" pattern="[0-9]{4}" maxlength="4" placeholder="4 digits" autocomplete="new-password" />

        <label for="note">Note (optional)</label>
        <input id="note" placeholder="Optional reason for the platform admin" />

        <div class="btnRow" style="margin-top:12px;">
          <button class="btn" type="submit">Submit request</button>
          <button class="btn secondary" id="clearBtn" type="button">Clear</button>
        </div>
      </form>
      <div class="small" style="margin-top:10px;">
        Requests are reviewed by the platform admin. Your login does not change until approved.
      </div>
    </section>

    <div id="saveBar"></div>
  </div>

  <script src="assets/config.example.js"></script>
  <script src="assets/config.js"></script>
  <script src="assets/store.js"></script>
  <script src="assets/app.js"></script>
  <script>
    (async () => {
      await JanitorApp.init({ pageTitle: "My Account • Cyber Solutions LLC Schedule Manager", wireSaveBar: false });

      const session = JanitorAuth.getSession();
      const accountMetaEl = document.getElementById("accountMeta");
      const newUsernameEl = document.getElementById("newUsername");
      const newPinEl = document.getElementById("newPin");
      const noteEl = document.getElementById("note");

      const normalizeCompany = (s) => String(s || "").trim().toUpperCase();
      const normalizeUsername = (s) => String(s || "").trim().toLowerCase();
      const pinOk = (p) => /^[0-9]{4}$/.test(String(p || "").trim());

      function renderMeta() {
        accountMetaEl.textContent =
          `Company code: ${normalizeCompany(session?.companyCode)} • Username: ${normalizeUsername(session?.username)}`;
      }

      document.getElementById("clearBtn").addEventListener("click", () => {
        newUsernameEl.value = "";
        newPinEl.value = "";
        noteEl.value = "";
        newUsernameEl.focus();
      });

      document.getElementById("requestForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const nextUsername = normalizeUsername(newUsernameEl.value);
        const nextPin = String(newPinEl.value || "").trim();
        const note = String(noteEl.value || "").trim();

        const wantsPin = pinOk(nextPin);
        const wantsUsername = !!nextUsername && nextUsername !== normalizeUsername(session?.username);
        if (!wantsPin && !wantsUsername) return JanitorApp.toast("Enter a new username and/or a new PIN.", { type: "warn" });
        if (wantsUsername && !wantsPin) return JanitorApp.toast("Changing the username requires setting a new PIN.", { type: "warn" });
        if (!wantsPin && nextPin) return JanitorApp.toast("PIN must be exactly 4 digits.", { type: "warn" });

        try {
          await JanitorStore.resetDraftToSaved();
          JanitorStore.createRequest({
            type: "manager_change_credentials",
            proposedUsername: wantsUsername ? nextUsername : "",
            proposedPin: wantsPin ? nextPin : "",
            note,
          });
          await JanitorStore.save();
          JanitorApp.toast("Request submitted.", { type: "success" });
          newUsernameEl.value = "";
          newPinEl.value = "";
          noteEl.value = "";
          JanitorApp.updateRequestBadges?.();
        } catch (err) {
          try { await JanitorStore.resetDraftToSaved(); } catch {}
          JanitorApp.toast(err?.message || "Request failed.", { type: "error" });
        }
      });

      renderMeta();
      JanitorApp.updateRequestBadges?.();
    })();
  </script>
</body>
</html>
