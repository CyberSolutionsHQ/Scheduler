<!doctype html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0e1520">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login • Cyber Solutions LLC Schedule Manager</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <header class="header">
    <div class="title">
      <div>
        <h1 class="h1">Cyber Solutions LLC Schedule Manager</h1>
        <div class="sub">Sign in to continue</div>
      </div>
    </div>
  </header>

  <div class="container">
    <section class="card" id="setupCard" style="display:none;">
      <h2>One-time setup</h2>
      <div class="small" style="margin-bottom:10px;">
        A platform admin account is required before any companies can be onboarded on this device.
      </div>
      <form id="setupForm" autocomplete="off">
        <label for="setupKey">Master setup key</label>
        <input id="setupKey" type="password" autocomplete="off" placeholder="Provided by the installer" />

        <label for="setupUsername">Platform admin username</label>
        <input id="setupUsername" placeholder="e.g., admin" autocomplete="username" autocapitalize="none" />

        <label for="setupPin">Platform admin PIN</label>
        <input id="setupPin" type="password" inputmode="numeric" pattern="[0-9]{4}" maxlength="4" placeholder="4 digits" autocomplete="new-password" />

        <div class="btnRow">
          <button class="btn" id="setupBtn" type="submit">Create platform admin</button>
          <button class="btn secondary" id="setupClearBtn" type="button">Clear</button>
        </div>
        <div class="small" style="margin-top:10px; opacity:.9;">
          After setup completes, the platform admin can create company codes and manager accounts.
        </div>
      </form>
    </section>

    <section class="card">
      <h2>Login</h2>
      <form id="loginForm" autocomplete="on">
        <label for="companyCode">Company code</label>
        <input id="companyCode" placeholder="e.g., CYBER" autocomplete="organization" autocapitalize="characters" />

        <label for="username">Username</label>
        <input id="username" placeholder="e.g., manager1" autocomplete="username" autocapitalize="none" />

        <label for="pin">PIN</label>
        <input id="pin" type="password" inputmode="numeric" pattern="[0-9]{4}" maxlength="4" placeholder="4 digits" autocomplete="current-password" />

        <div class="btnRow">
          <button class="btn" id="loginBtn" type="submit">Sign in</button>
          <button class="btn secondary" id="clearBtn" type="button">Clear</button>
        </div>

        <div class="small" style="margin-top:10px;">
          Company codes and manager accounts are created by the <strong>platform admin</strong>.
          Employee logins are created by a manager in <strong>Users / Access</strong>.
        </div>

        <div class="small" style="margin-top:10px;">
          <a href="#" id="recoverLink">Forgot username or PIN? (requires master setup key)</a>
        </div>
      </form>
    </section>

    <section class="card" id="recoverCard" style="display:none;">
      <h2>Account recovery</h2>
      <div class="small" style="margin-bottom:10px;">
        Use the master setup key to look up accounts and reset a PIN. This does not delete company data.
      </div>
      <form id="recoverForm" autocomplete="off">
        <label for="recoverKey">Master setup key</label>
        <input id="recoverKey" type="password" autocomplete="off" placeholder="Required" />

        <div class="btnRow" style="margin-top:12px;">
          <button class="btn" id="unlockRecoverBtn" type="button">Unlock recovery</button>
          <button class="btn secondary" id="recoverCancelBtn" type="button">Close</button>
        </div>

        <div id="recoverBody" style="display:none; margin-top:12px;">
          <div class="hr"></div>

          <label for="recoverCompany">Company</label>
          <select id="recoverCompany"></select>

          <label for="recoverUser">Username</label>
          <select id="recoverUser"></select>

          <label for="recoverPin">New 4-digit PIN</label>
          <input id="recoverPin" type="password" inputmode="numeric" pattern="[0-9]{4}" maxlength="4" placeholder="4 digits" autocomplete="new-password" />

          <div class="btnRow" style="margin-top:12px;">
            <button class="btn danger" type="submit">Reset PIN</button>
            <button class="btn secondary" id="recoverClearBtn" type="button">Clear</button>
          </div>

          <div class="small" id="recoverHint" style="margin-top:10px; opacity:.9;"></div>
        </div>
      </form>
    </section>
  </div>

  <script src="assets/config.example.js"></script>
  <script src="assets/config.js"></script>
  <script src="assets/store.js"></script>
  <script src="assets/app.js"></script>
  <script>
    (() => {
      const companyEl = document.getElementById("companyCode");
      const userEl = document.getElementById("username");
      const pinEl = document.getElementById("pin");

      const setupCard = document.getElementById("setupCard");
      const loginCard = document.getElementById("loginForm")?.closest(".card");
      const setupKeyEl = document.getElementById("setupKey");
      const setupUserEl = document.getElementById("setupUsername");
      const setupPinEl = document.getElementById("setupPin");

      const recoverLink = document.getElementById("recoverLink");
      const recoverCard = document.getElementById("recoverCard");
      const recoverKeyEl = document.getElementById("recoverKey");
      const recoverBody = document.getElementById("recoverBody");
      const recoverCompanyEl = document.getElementById("recoverCompany");
      const recoverUserEl = document.getElementById("recoverUser");
      const recoverPinEl = document.getElementById("recoverPin");
      const recoverHint = document.getElementById("recoverHint");

      const lastCompany = window.JanitorAuth?.getLastCompanyCode?.();
      if (lastCompany) companyEl.value = lastCompany;

      companyEl.addEventListener("input", () => {
        companyEl.value = String(companyEl.value || "").toUpperCase();
      });

      document.getElementById("clearBtn").addEventListener("click", () => {
        companyEl.value = "";
        userEl.value = "";
        pinEl.value = "";
        companyEl.focus();
      });

      document.getElementById("setupClearBtn").addEventListener("click", () => {
        setupKeyEl.value = "";
        setupUserEl.value = "";
        setupPinEl.value = "";
        setupKeyEl.focus();
      });

      async function boot() {
        try {
          const exists = await window.JanitorAuth.platformAdminExists();
          if (!exists) {
            setupCard.style.display = "block";
            if (loginCard) loginCard.style.display = "none";
            setupKeyEl.focus();
          } else {
            setupCard.style.display = "none";
            if (loginCard) loginCard.style.display = "block";
            companyEl.focus();
          }
        } catch {
          // If storage is blocked, leave login visible and let sign-in show the error.
          setupCard.style.display = "none";
          if (loginCard) loginCard.style.display = "block";
        }
      }

      document.getElementById("setupForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const setupKey = String(setupKeyEl.value || "").trim();
        const username = String(setupUserEl.value || "").trim();
        const pin = String(setupPinEl.value || "").trim();

        try {
          await window.JanitorAuth.createPlatformAdmin({ username, pin, setupKey });
          window.JanitorAuth.goAfterLogin({ next: "admin.html" });
        } catch (err) {
          window.JanitorApp.toast(err?.message || "Setup failed.", { type: "error" });
        }
      });

      document.getElementById("loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const companyCode = (companyEl.value || "").trim();
        const username = (userEl.value || "").trim();
        const pin = (pinEl.value || "").trim();

        try {
          await window.JanitorAuth.signIn({ companyCode, username, pin });
          const next = window.JanitorApp.qs("next");
          window.JanitorAuth.goAfterLogin({ next });
        } catch (err) {
          window.JanitorApp.toast(err?.message || "Login failed.", { type: "error" });
        }
      });

      recoverLink.addEventListener("click", (e) => {
        e.preventDefault();
        recoverCard.style.display = recoverCard.style.display === "none" ? "block" : "none";
        recoverKeyEl.focus();
      });

      document.getElementById("recoverCancelBtn").addEventListener("click", () => {
        recoverCard.style.display = "none";
        recoverKeyEl.value = "";
        recoverBody.style.display = "none";
        recoverCompanyEl.innerHTML = "";
        recoverUserEl.innerHTML = "";
        recoverPinEl.value = "";
        recoverHint.textContent = "";
      });

      function escape(s) { return window.JanitorApp.escapeHtml(s); }
      const normalizeCompany = (s) => String(s || "").trim().toUpperCase();

      async function loadRecoveryCompanies() {
        const setupKey = String(recoverKeyEl.value || "").trim();
        const companies = await window.JanitorAuth.recoveryListCompanies({ setupKey });
        recoverCompanyEl.innerHTML = "";
        if (!companies.length) {
          recoverCompanyEl.innerHTML = `<option value="">No companies found</option>`;
          recoverCompanyEl.disabled = true;
          return;
        }
        recoverCompanyEl.disabled = false;
        companies.forEach(c => {
          const label = `${c.companyCode}${c.companyName ? ` — ${c.companyName}` : ""}${c.isDisabled ? " (Disabled)" : ""}`;
          recoverCompanyEl.insertAdjacentHTML("beforeend", `<option value="${escape(c.companyCode)}">${escape(label)}</option>`);
        });
        if (!recoverCompanyEl.value) recoverCompanyEl.value = companies[0].companyCode;
      }

      async function loadRecoveryUsers() {
        const setupKey = String(recoverKeyEl.value || "").trim();
        const companyCode = normalizeCompany(recoverCompanyEl.value);
        if (!companyCode) {
          recoverUserEl.innerHTML = `<option value="">No accounts</option>`;
          recoverUserEl.disabled = true;
          recoverHint.textContent = "No companies are available for recovery on this device.";
          return;
        }
        const users = await window.JanitorAuth.recoveryListUsers({ setupKey, companyCode });
        recoverUserEl.innerHTML = "";
        if (!users.length) {
          recoverUserEl.innerHTML = `<option value="">No accounts found</option>`;
          recoverUserEl.disabled = true;
          recoverHint.textContent = "No accounts found for this company code.";
          return;
        }
        recoverUserEl.disabled = false;
        users.forEach(u => {
          const label = `${u.username} (${u.role}${u.active ? "" : ", inactive"})`;
          recoverUserEl.insertAdjacentHTML("beforeend", `<option value="${escape(u.username)}">${escape(label)}</option>`);
        });
        recoverHint.textContent = "Select an account and set a new 4-digit PIN.";
      }

      document.getElementById("unlockRecoverBtn").addEventListener("click", async () => {
        try {
          await loadRecoveryCompanies();
          await loadRecoveryUsers();
          recoverBody.style.display = "block";
          recoverCompanyEl.focus();
        } catch (err) {
          window.JanitorApp.toast(err?.message || "Recovery unlock failed.", { type: "error" });
        }
      });

      recoverCompanyEl.addEventListener("change", async () => {
        try {
          await loadRecoveryUsers();
        } catch (err) {
          window.JanitorApp.toast(err?.message || "Could not load accounts.", { type: "error" });
        }
      });

      document.getElementById("recoverClearBtn").addEventListener("click", () => {
        recoverPinEl.value = "";
        recoverPinEl.focus();
      });

      document.getElementById("recoverForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const setupKey = String(recoverKeyEl.value || "").trim();
        const companyCode = normalizeCompany(recoverCompanyEl.value);
        const username = String(recoverUserEl.value || "").trim();
        const newPin = String(recoverPinEl.value || "").trim();
        if (!companyCode) return window.JanitorApp.toast("Select a company.", { type: "warn" });
        if (!username) return window.JanitorApp.toast("Select a username.", { type: "warn" });
        if (!/^[0-9]{4}$/.test(newPin)) return window.JanitorApp.toast("PIN must be exactly 4 digits.", { type: "warn" });

        const ok = await window.JanitorApp.confirmBox(`Reset PIN for "${username}" in company "${companyCode}"?`);
        if (!ok) return;

        try {
          await window.JanitorAuth.recoveryResetPin({ setupKey, companyCode, username, newPin });
          window.JanitorApp.toast("PIN reset. You can sign in now.", { type: "success" });
          companyEl.value = companyCode;
          userEl.value = username;
          pinEl.value = "";
          pinEl.focus();
        } catch (err) {
          window.JanitorApp.toast(err?.message || "Reset failed.", { type: "error" });
        }
      });

      boot();
    })();
  </script>
</body>
</html>
