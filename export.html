<!doctype html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e1520">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Export PDFs â€¢ Cyber Solutions LLC Schedule Manager</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <header class="header">
    <div class="title">
      <div>
        <h1 class="h1">Cyber Solutions LLC Schedule Manager</h1>
        <div class="sub">Export PDFs â€¢ Exports use <strong>Saved</strong> data â€¢ Tap Save on other pages before exporting.</div>
      </div>
    </div>

    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="employees.html">Employees</a>
      <a href="locations.html">Locations</a>
      <a href="jobs.html">Jobs</a>
      <a href="shifts.html">Shifts</a>
      <a href="crews.html">Crews</a>
      <a class="active" href="export.html">Export PDFs</a>
      <a href="users.html">Users / Access</a>
      <a href="employee-requests.html">Employee Requests <span class="badge" data-badge="employeeRequests" style="display:none;"></span></a>
      <a href="account.html">My Account</a>
      <a href="settings.html">Settings</a>
    </nav>
  </header>

  <div class="container">
    <section class="card" id="unsavedCard" style="display:none;">
      <h2>Unsaved changes</h2>
      <div class="small">
        You currently have unsaved changes in your draft. PDF export pulls from <strong>Saved</strong> data only.
        Go back and tap <strong>Save</strong> first, then export.
      </div>
      <div class="btnRow" style="margin-top:10px;">
        <a class="btn" href="shifts.html">Go to Shifts</a>
        <a class="btn secondary" href="index.html">Go Home</a>
      </div>
    </section>

    <section class="card">
      <h2>Export one employee</h2>

      <div class="row two">
        <div>
          <label for="empSel">Employee</label>
          <select id="empSel"></select>
        </div>
        <div>
          <label>Tip</label>
          <div class="small" style="padding:11px 12px; border:1px solid var(--border2); border-radius:12px; background:var(--panel2);">
            When the print page opens, tap <strong>Print / Save as PDF</strong> and save as
            <strong>Schedule/EmployeeName.pdf</strong>.
          </div>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn" id="openPdfBtn" type="button">ðŸ“„ Open PDF / Print view</button>
        <button class="btn secondary" id="copyLinkBtn" type="button">ðŸ”— Copy print link</button>
      </div>

      <div class="small" id="singleHint" style="margin-top:10px;"></div>
    </section>

    <section class="card">
      <h2>Export one crew</h2>

      <div class="row two">
        <div>
          <label for="crewSel">Crew</label>
          <select id="crewSel"></select>
        </div>
        <div>
          <label for="crewMode">Export type</label>
          <select id="crewMode">
            <option value="daily" selected>Daily crew schedule</option>
            <option value="weekly">Weekly crew schedule</option>
          </select>
        </div>
      </div>

      <div class="row two" id="crewDailyRow">
        <div>
          <label for="crewDate">Date</label>
          <input id="crewDate" type="date" />
        </div>
        <div>
          <label>Save as</label>
          <div class="small" style="padding:11px 12px; border:1px solid var(--border2); border-radius:12px; background:var(--panel2);">
            <strong>Schedule/Crew_&lt;CrewName&gt;_YYYY-MM-DD_Daily.pdf</strong>
          </div>
        </div>
      </div>

      <div class="row two" id="crewWeeklyRow" style="display:none;">
        <div>
          <label for="crewWeekStart">Week start date (Mon)</label>
          <input id="crewWeekStart" type="date" />
        </div>
        <div>
          <label>Save as</label>
          <div class="small" style="padding:11px 12px; border:1px solid var(--border2); border-radius:12px; background:var(--panel2);">
            <strong>Schedule/Crew_&lt;CrewName&gt;_YYYY-MM-DD_Weekly.pdf</strong>
          </div>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn" id="openCrewBtn" type="button">ðŸ“„ Open PDF / Print view</button>
        <button class="btn secondary" id="copyCrewLinkBtn" type="button">ðŸ”— Copy print link</button>
      </div>

      <div class="small" id="crewHint" style="margin-top:10px;"></div>
    </section>

    <section class="card">
      <h2>All Crews PDF</h2>

      <div class="row two">
        <div>
          <label for="allCrewsMode">Export type</label>
          <select id="allCrewsMode">
            <option value="daily" selected>All crews â€” Daily schedule</option>
            <option value="weekly">All crews â€” Weekly schedule</option>
          </select>
        </div>
        <div>
          <label>Tip</label>
          <div class="small" style="padding:11px 12px; border:1px solid var(--border2); border-radius:12px; background:var(--panel2);">
            This creates a single printable report with every crew, members, and the selected periodâ€™s crew-assigned shifts.
          </div>
        </div>
      </div>

      <div class="row two" id="allCrewsDailyRow">
        <div>
          <label for="allCrewsDate">Date</label>
          <input id="allCrewsDate" type="date" />
        </div>
        <div>
          <label>Save as</label>
          <div class="small" style="padding:11px 12px; border:1px solid var(--border2); border-radius:12px; background:var(--panel2);">
            <strong>Schedule/AllCrews_YYYY-MM-DD_Daily.pdf</strong>
          </div>
        </div>
      </div>

      <div class="row two" id="allCrewsWeeklyRow" style="display:none;">
        <div>
          <label for="allCrewsWeekStart">Week start date (Mon)</label>
          <input id="allCrewsWeekStart" type="date" />
        </div>
        <div>
          <label>Save as</label>
          <div class="small" style="padding:11px 12px; border:1px solid var(--border2); border-radius:12px; background:var(--panel2);">
            <strong>Schedule/AllCrews_YYYY-MM-DD_Weekly.pdf</strong>
          </div>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn" id="openAllCrewsBtn" type="button">ðŸ“„ Open Print View</button>
        <button class="btn secondary" id="copyAllCrewsLinkBtn" type="button">ðŸ”— Copy print link</button>
      </div>

      <div class="small" id="allCrewsHint" style="margin-top:10px;"></div>
    </section>

    <section class="card">
      <h2>Export all employees</h2>
      <div class="small">
        Mobile browsers wonâ€™t auto-save all PDFs to a folder. This tool helps you export one-by-one fast.
      </div>
      <div class="hr"></div>
      <div id="exportAllWrap"></div>
    </section>

    <!-- Save bar exists here too (even though export is read-only) -->
    <div id="saveBar"></div>
  </div>

  <script src="assets/store.js"></script>
  <script src="assets/app.js"></script>
  <script src="assets/pdf.js"></script>
  <script>
    (async () => {
      await JanitorApp.init({ pageTitle: "Export PDFs â€¢ Cyber Solutions LLC Schedule Manager" });

      const empSel = document.getElementById("empSel");
      const crewSel = document.getElementById("crewSel");
      const crewMode = document.getElementById("crewMode");
      const crewDate = document.getElementById("crewDate");
      const crewWeekStart = document.getElementById("crewWeekStart");
      const crewDailyRow = document.getElementById("crewDailyRow");
      const crewWeeklyRow = document.getElementById("crewWeeklyRow");
      const crewHint = document.getElementById("crewHint");
      const allCrewsMode = document.getElementById("allCrewsMode");
      const allCrewsDate = document.getElementById("allCrewsDate");
      const allCrewsWeekStart = document.getElementById("allCrewsWeekStart");
      const allCrewsDailyRow = document.getElementById("allCrewsDailyRow");
      const allCrewsWeeklyRow = document.getElementById("allCrewsWeeklyRow");
      const allCrewsHint = document.getElementById("allCrewsHint");
      const unsavedCard = document.getElementById("unsavedCard");
      const singleHint = document.getElementById("singleHint");
      const exportAllWrap = document.getElementById("exportAllWrap");

      function opt(value, label){
        return `<option value="${JanitorApp.escapeHtml(value)}">${JanitorApp.escapeHtml(label)}</option>`;
      }

      function renderEmployees() {
        const emps = JanitorPDF.getEmployeesForExport();
        empSel.innerHTML = `<option value="">â€” Select â€”</option>` + emps.map(e => opt(e.id, e.name)).join("");
        singleHint.textContent = emps.length ? `${emps.length} employee(s) available for export.` : "No employees yet.";
      }

      function renderCrews() {
        const crews = JanitorPDF.getCrewsForExport();
        crewSel.innerHTML = `<option value="">â€” Select â€”</option>` + crews.map(c => opt(c.id, c.name)).join("");
        crewHint.textContent = crews.length ? `${crews.length} crew(s) available for export.` : "No crews yet.";
        allCrewsHint.textContent = crews.length
          ? `${crews.length} crew(s) will be included. Crews with no shifts still appear.`
          : "No crews yet.";
      }

      function renderCrewMode() {
        const mode = crewMode.value;
        crewDailyRow.style.display = mode === "daily" ? "grid" : "none";
        crewWeeklyRow.style.display = mode === "weekly" ? "grid" : "none";
      }

      function renderAllCrewsMode() {
        const mode = allCrewsMode.value;
        allCrewsDailyRow.style.display = mode === "daily" ? "grid" : "none";
        allCrewsWeeklyRow.style.display = mode === "weekly" ? "grid" : "none";
      }

      function checkUnsaved() {
        const dirty = JanitorStore.isDirty();
        unsavedCard.style.display = dirty ? "block" : "none";
        if (dirty) {
          JanitorApp.toast("You have unsaved changes. Export uses Saved data.", { type: "warn", ms: 2600 });
        }
      }

      document.getElementById("openPdfBtn").addEventListener("click", () => {
        const empId = empSel.value;
        if (!empId) return JanitorApp.toast("Select an employee first.", { type: "error" });
        if (JanitorStore.isDirty()) {
          JanitorApp.toast("Tap Save on other pages first (export uses Saved data).", { type: "warn", ms: 2600 });
          // Still allow opening if they insist, but warn strongly.
        }
        JanitorPDF.openPrint(empId, { newTab: true });
      });

      document.getElementById("copyLinkBtn").addEventListener("click", async () => {
        const empId = empSel.value;
        if (!empId) return JanitorApp.toast("Select an employee first.", { type: "error" });

        const url = JanitorPDF.buildPrintUrl(empId);
        try {
          await navigator.clipboard.writeText(url);
          JanitorApp.toast("Print link copied âœ…", { type: "success" });
        } catch {
          // Fallback: download a .txt with the link
          JanitorApp.downloadText("print_link.txt", url, "text/plain");
          JanitorApp.toast("Clipboard blocked. Downloaded link instead.", { type: "warn" });
        }
      });

      document.getElementById("openCrewBtn").addEventListener("click", () => {
        const crewId = crewSel.value;
        if (!crewId) return JanitorApp.toast("Select a crew first.", { type: "error" });

        const mode = crewMode.value;
        const date = crewDate.value;
        const weekStart = crewWeekStart.value;

        if (mode === "daily" && !date) return JanitorApp.toast("Select a date first.", { type: "error" });
        if (mode === "weekly" && !weekStart) return JanitorApp.toast("Select a week start date first.", { type: "error" });

        if (JanitorStore.isDirty()) {
          JanitorApp.toast("Tap Save on other pages first (export uses Saved data).", { type: "warn", ms: 2600 });
        }

        JanitorPDF.openCrewPrint({ crewId, mode, date, weekStart }, { newTab: true });
      });

      document.getElementById("copyCrewLinkBtn").addEventListener("click", async () => {
        const crewId = crewSel.value;
        if (!crewId) return JanitorApp.toast("Select a crew first.", { type: "error" });

        const mode = crewMode.value;
        const date = crewDate.value;
        const weekStart = crewWeekStart.value;

        if (mode === "daily" && !date) return JanitorApp.toast("Select a date first.", { type: "error" });
        if (mode === "weekly" && !weekStart) return JanitorApp.toast("Select a week start date first.", { type: "error" });

        const url = JanitorPDF.buildCrewPrintUrl({ crewId, mode, date, weekStart });
        try {
          await navigator.clipboard.writeText(url);
          JanitorApp.toast("Print link copied âœ…", { type: "success" });
        } catch {
          JanitorApp.downloadText("crew_print_link.txt", url, "text/plain");
          JanitorApp.toast("Clipboard blocked. Downloaded link instead.", { type: "warn" });
        }
      });

      crewMode.addEventListener("change", renderCrewMode);
      allCrewsMode.addEventListener("change", renderAllCrewsMode);

      document.getElementById("openAllCrewsBtn").addEventListener("click", () => {
        const mode = allCrewsMode.value;
        const date = allCrewsDate.value;
        const weekStart = allCrewsWeekStart.value;

        if (mode === "daily" && !date) return JanitorApp.toast("Select a date first.", { type: "error" });
        if (mode === "weekly" && !weekStart) return JanitorApp.toast("Select a week start date first.", { type: "error" });

        if (JanitorStore.isDirty()) {
          JanitorApp.toast("Tap Save on other pages first (export uses Saved data).", { type: "warn", ms: 2600 });
        }

        JanitorPDF.openAllCrewsPrint({ mode, date, weekStart }, { newTab: true });
      });

      document.getElementById("copyAllCrewsLinkBtn").addEventListener("click", async () => {
        const mode = allCrewsMode.value;
        const date = allCrewsDate.value;
        const weekStart = allCrewsWeekStart.value;

        if (mode === "daily" && !date) return JanitorApp.toast("Select a date first.", { type: "error" });
        if (mode === "weekly" && !weekStart) return JanitorApp.toast("Select a week start date first.", { type: "error" });

        const url = JanitorPDF.buildAllCrewsPrintUrl({ mode, date, weekStart });
        try {
          await navigator.clipboard.writeText(url);
          JanitorApp.toast("Print link copied âœ…", { type: "success" });
        } catch {
          JanitorApp.downloadText("all_crews_print_link.txt", url, "text/plain");
          JanitorApp.toast("Clipboard blocked. Downloaded link instead.", { type: "warn" });
        }
      });

      // Build "Export All" helper UI
      JanitorPDF.startExportAllUI(exportAllWrap);

      // initial
      renderEmployees();
      renderCrews();
      renderCrewMode();
      renderAllCrewsMode();
      checkUnsaved();

      // If user saves/discards elsewhere and comes back, refresh list
      window.addEventListener("focus", () => {
        renderEmployees();
        renderCrews();
        checkUnsaved();
      });

      window.addEventListener("janitor:discard", () => {
        renderEmployees();
        renderCrews();
        checkUnsaved();
      });
    })();
  </script>
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
</script>
</body>
</html>
