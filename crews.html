<!doctype html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0e1520">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crews • Cyber Solutions LLC Schedule Manager</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <header class="header">
    <div class="title">
      <div>
        <h1 class="h1">Cyber Solutions LLC Schedule Manager</h1>
        <div class="sub">Crews • Create crews and assign employees</div>
      </div>
    </div>

    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="employees.html">Employees</a>
      <a href="locations.html">Locations</a>
      <a href="jobs.html">Jobs</a>
      <a href="shifts.html">Shifts</a>
      <a class="active" href="crews.html">Crews</a>
      <a href="export.html">Export PDFs</a>
      <a href="users.html">Users / Access</a>
      <a href="employee-requests.html">Employee Requests <span class="badge" data-badge="employeeRequests" style="display:none;"></span></a>
      <a href="account.html">My Account</a>
      <a href="settings.html">Settings</a>
    </nav>
  </header>

  <div class="container">
    <section class="card">
      <h2>Create crew</h2>
      <div class="row two">
        <div>
          <label for="crewName">Crew name</label>
          <input id="crewName" placeholder="e.g., Night Crew" autocomplete="organization" />
        </div>
        <div>
          <label for="crewActive">Active</label>
          <select id="crewActive">
            <option value="1" selected>Active</option>
            <option value="0">Inactive</option>
          </select>
        </div>
      </div>
      <div class="btnRow">
        <button class="btn" id="addCrewBtn" type="button">➕ Add crew</button>
        <button class="btn secondary" id="clearCrewBtn" type="button">Clear</button>
      </div>
      <div class="small" style="margin-top:10px;">
        Tip: Assign shifts to a crew from the Shifts page. Crew shifts are visible to all members (read-only).
      </div>
    </section>

    <section class="card">
      <h2>Crew list</h2>
      <div class="small" id="crewCount">Loading…</div>
      <div id="crewList" class="list"></div>
    </section>

    <section class="card" id="membersCard">
      <h2>Crew members</h2>
      <div class="small" id="membersHint">Select a crew to manage members.</div>

      <div id="membersControls" style="display:none;">
        <div class="row two">
          <div>
            <label for="memberSel">Add employee</label>
            <select id="memberSel"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn" id="addMemberBtn" type="button">Add to crew</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="membersList" class="list"></div>
      </div>
    </section>

    <!-- Save bar -->
    <div id="saveBar"></div>
  </div>

  <script src="assets/config.example.js"></script>
  <script src="assets/config.js"></script>
  <script src="assets/store.js"></script>
  <script src="assets/app.js"></script>
  <script>
    (async () => {
      await JanitorApp.init({ pageTitle: "Crews • Cyber Solutions LLC Schedule Manager" });

      const crewNameEl = document.getElementById("crewName");
      const crewActiveEl = document.getElementById("crewActive");
      const crewCountEl = document.getElementById("crewCount");
      const crewListEl = document.getElementById("crewList");

      const membersHintEl = document.getElementById("membersHint");
      const membersControlsEl = document.getElementById("membersControls");
      const memberSelEl = document.getElementById("memberSel");
      const membersListEl = document.getElementById("membersList");

      let selectedCrewId = "";

      function opt(value, label) {
        return `<option value="${JanitorApp.escapeHtml(value)}">${JanitorApp.escapeHtml(label)}</option>`;
      }

      function getCrew(crewId, s) {
        return (s.crews || []).find(c => c.id === crewId) || null;
      }

      function crewMemberEmpIds(crewId, s) {
        return new Set((s.crewMembers || []).filter(cm => cm.crewId === crewId).map(cm => cm.empId));
      }

      function ensureSelectedCrew(s) {
        const crews = (s.crews || []).slice().sort((a,b) => (a.name || "").localeCompare(b.name || ""));
        if (selectedCrewId && crews.some(c => c.id === selectedCrewId)) return;
        selectedCrewId = crews[0]?.id || "";
      }

      function renderCrewList() {
        const s = JanitorStore.getDraft();
        const crews = (s.crews || []).slice().sort((a,b) => (a.name || "").localeCompare(b.name || ""));
        crewCountEl.textContent = `${crews.length} crew(s)`;

        ensureSelectedCrew(s);

        crewListEl.innerHTML = "";
        if (crews.length === 0) {
          crewListEl.innerHTML = `<div class="small">No crews yet. Create one above.</div>`;
          renderMembers();
          return;
        }

        const empById = Object.fromEntries((s.employees || []).map(e => [e.id, e]));
        for (const c of crews) {
          const div = document.createElement("div");
          div.className = "item";

          const memberIds = crewMemberEmpIds(c.id, s);
          const activeCount = Array.from(memberIds).filter(id => empById[id] && empById[id].active !== false).length;
          const totalCount = memberIds.size;

          div.innerHTML = `
            <div class="meta">
              <strong>${JanitorApp.escapeHtml(c.name)}</strong>
              <div class="muted">Members: ${activeCount}${activeCount !== totalCount ? ` active / ${totalCount} total` : ""}</div>
              <span class="pill">ID: ${JanitorApp.escapeHtml(c.id)}</span>
              <div class="small" style="margin-top:8px;">
                <label style="margin:0 0 4px;">Status</label>
                <select data-crew-active="${JanitorApp.escapeHtml(c.id)}">
                  <option value="1" ${c.active !== false ? "selected" : ""}>Active</option>
                  <option value="0" ${c.active === false ? "selected" : ""}>Inactive</option>
                </select>
              </div>
            </div>
            <div class="actions">
              <button class="btn secondary" type="button" data-select="${JanitorApp.escapeHtml(c.id)}">Manage</button>
              <button class="btn secondary" type="button" data-rename="${JanitorApp.escapeHtml(c.id)}">Rename</button>
              <button class="btn danger" type="button" data-del="${JanitorApp.escapeHtml(c.id)}">Delete</button>
            </div>
          `;
          if (c.id === selectedCrewId) {
            div.style.boxShadow = "0 0 0 1px rgba(122,209,255,0.18) inset, var(--shadow)";
            div.style.borderColor = "rgba(122,209,255,0.35)";
          }
          crewListEl.appendChild(div);
        }

        renderMembers();
      }

      function renderMembers() {
        const s = JanitorStore.getDraft();
        const crew = selectedCrewId ? getCrew(selectedCrewId, s) : null;

        if (!crew) {
          membersHintEl.textContent = "Select a crew to manage members.";
          membersControlsEl.style.display = "none";
          return;
        }

        membersHintEl.innerHTML =
          `Managing: <strong>${JanitorApp.escapeHtml(crew.name)}</strong> (${crew.active !== false ? "Active" : "Inactive"})`;
        membersControlsEl.style.display = "block";

        const memberIds = crewMemberEmpIds(crew.id, s);
        const employees = (s.employees || []).slice().sort((a,b) => (a.name || "").localeCompare(b.name || ""));

        const available = employees.filter(e => e.active !== false && !memberIds.has(e.id));
        memberSelEl.innerHTML = available.length
          ? `<option value="">— Select —</option>` + available.map(e => opt(e.id, e.name)).join("")
          : `<option value="">No available employees</option>`;

        const members = employees.filter(e => memberIds.has(e.id));
        membersListEl.innerHTML = "";
        if (members.length === 0) {
          membersListEl.innerHTML = `<div class="small">No members yet.</div>`;
          return;
        }

        for (const e of members) {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div class="meta">
              <strong>${JanitorApp.escapeHtml(e.name)}</strong>
              ${e.contact ? `<div class="muted">${JanitorApp.escapeHtml(e.contact)}</div>` : `<div class="muted">No contact info</div>`}
              ${e.active === false ? `<span class="pill">Inactive employee</span>` : ""}
            </div>
            <div class="actions">
              <button class="btn danger" type="button" data-remove="${JanitorApp.escapeHtml(e.id)}">Remove</button>
            </div>
          `;
          membersListEl.appendChild(div);
        }
      }

      function clearCrewForm() {
        crewNameEl.value = "";
        crewActiveEl.value = "1";
        crewNameEl.focus();
      }

      document.getElementById("addCrewBtn").addEventListener("click", () => {
        try {
          const crew = JanitorStore.addCrew({
            name: crewNameEl.value,
            active: crewActiveEl.value === "1",
          });
          selectedCrewId = crew.id;
          JanitorApp.toast("Crew added (tap Save) ✅", { type: "success" });
          JanitorApp.markDirty();
          clearCrewForm();
          renderCrewList();
        } catch (e) {
          JanitorApp.toast(e.message || "Could not add crew.", { type: "error" });
        }
      });

      document.getElementById("clearCrewBtn").addEventListener("click", clearCrewForm);

      crewListEl.addEventListener("click", async (ev) => {
        const selectBtn = ev.target.closest("button[data-select]");
        if (selectBtn) {
          selectedCrewId = selectBtn.getAttribute("data-select") || "";
          renderCrewList();
          return;
        }

        const renameBtn = ev.target.closest("button[data-rename]");
        if (renameBtn) {
          const id = renameBtn.getAttribute("data-rename");
          const s = JanitorStore.getDraft();
          const crew = getCrew(id, s);
          if (!crew) return;
          const next = window.prompt("Rename crew:", crew.name);
          if (next === null) return;
          try {
            JanitorStore.updateCrew(id, { name: next });
            JanitorApp.toast("Crew renamed (tap Save) ✅", { type: "success" });
            JanitorApp.markDirty();
            renderCrewList();
          } catch (e) {
            JanitorApp.toast(e.message || "Rename failed.", { type: "error" });
          }
          return;
        }

        const delBtn = ev.target.closest("button[data-del]");
        if (delBtn) {
          const id = delBtn.getAttribute("data-del");
          const ok = await JanitorApp.confirmBox("Delete this crew? (Any crew shifts will also be removed when you Save.)");
          if (!ok) return;
          try {
            JanitorStore.deleteCrew(id, { cascade: true });
            if (selectedCrewId === id) selectedCrewId = "";
            JanitorApp.toast("Crew deleted (tap Save) ⚠️", { type: "warn" });
            JanitorApp.markDirty();
            renderCrewList();
          } catch (e) {
            JanitorApp.toast(e.message || "Delete failed.", { type: "error" });
          }
        }
      });

      crewListEl.addEventListener("change", (ev) => {
        const sel = ev.target.closest("select[data-crew-active]");
        if (!sel) return;
        const id = sel.getAttribute("data-crew-active");
        try {
          JanitorStore.updateCrew(id, { active: sel.value === "1" });
          JanitorApp.toast("Crew updated (tap Save) ✅", { type: "success", ms: 1400 });
          JanitorApp.markDirty();
          renderCrewList();
        } catch (e) {
          JanitorApp.toast(e.message || "Update failed.", { type: "error" });
        }
      });

      document.getElementById("addMemberBtn").addEventListener("click", () => {
        const empId = memberSelEl.value;
        if (!selectedCrewId) return JanitorApp.toast("Select a crew first.", { type: "error" });
        if (!empId) return JanitorApp.toast("Select an employee first.", { type: "error" });
        try {
          JanitorStore.addCrewMember({ crewId: selectedCrewId, empId });
          JanitorApp.toast("Added to crew (tap Save) ✅", { type: "success" });
          JanitorApp.markDirty();
          renderMembers();
        } catch (e) {
          JanitorApp.toast(e.message || "Could not add member.", { type: "error" });
        }
      });

      membersListEl.addEventListener("click", async (ev) => {
        const btn = ev.target.closest("button[data-remove]");
        if (!btn) return;
        const empId = btn.getAttribute("data-remove");
        if (!selectedCrewId) return;
        const ok = await JanitorApp.confirmBox("Remove this employee from the crew? (Tap Save to commit.)");
        if (!ok) return;
        try {
          JanitorStore.removeCrewMember({ crewId: selectedCrewId, empId });
          JanitorApp.toast("Removed (tap Save) ⚠️", { type: "warn" });
          JanitorApp.markDirty();
          renderMembers();
        } catch (e) {
          JanitorApp.toast(e.message || "Remove failed.", { type: "error" });
        }
      });

      window.addEventListener("janitor:discard", () => {
        selectedCrewId = "";
        renderCrewList();
      });

      renderCrewList();
    })();
  </script>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
</body>
</html>
